<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registrar Compra</title>
</head>
<body>
    <h1>Registrar Compra a Proveedor</h1>
    <form id="form-compra">
        <label>Proveedor:</label>
        <select id="proveedorSelect"></select>
        <br>
        <label>Buscar producto:</label>
        <input type="text" id="buscarProducto" placeholder="Nombre o EAN">
        <br>
        <label>Producto:</label>
        <select id="productoSelect"></select>
        <br>
        <label>Cantidad:</label>
        <input type="number" id="cantidad" min="1" value="1">
        <br>
        <label>Precio de compra:</label>
        <input type="number" id="precioCompra" min="0" step="0.01">
        <br>
        <button type="button" id="agregarCompra">Registrar Compra</button>
    </form>
    <h2>Compras recientes</h2>
    <div id="totalHoy" style="font-weight: bold; margin-bottom: 10px;"></div>
    <table border="1">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Proveedor</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio de compra</th>
            </tr>
        </thead>
        <tbody id="comprasRecientes"></tbody>
    </table>
<script>
    let productosGlobal = [];

    async function cargarProveedores() {
        const res = await fetch('/proveedores');
        const proveedores = await res.json();
        const select = document.getElementById('proveedorSelect');
        select.innerHTML = '';
        proveedores.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.nombre;
            select.appendChild(option);
        });

        const proveedorGuardado = localStorage.getItem('proveedorSeleccionado');
        if (proveedorGuardado) {
            select.value = proveedorGuardado;
        }
        select.onchange = function() {
            localStorage.setItem('proveedorSeleccionado', this.value);
        };
    }

    async function cargarProductos() {
        const res = await fetch('/productos');
        productosGlobal = await res.json();
        renderSelectProductos();
    }

    function renderSelectProductos(filtro = '') {
        const select = document.getElementById('productoSelect');
        select.innerHTML = '';
        productosGlobal
            .filter(p =>
                p.nombre.toLowerCase().includes(filtro.toLowerCase()) ||
                p.ean.includes(filtro)
            )
            .forEach(p => {
                const option = document.createElement('option');
                option.value = p.ean;
                option.textContent = `${p.nombre} (EAN: ${p.ean}, Marca: ${p.marca_nombre ?? '-'}, Gramos: ${p.gramos ?? '-'}, Stock: ${p.stock ?? '-'})`;
                select.appendChild(option);
            });
    }

async function cargarCompras() {
    const res = await fetch('/compras');
    const compras = await res.json();
    const tbody = document.getElementById('comprasRecientes');
    tbody.innerHTML = '';

    const hoy = new Date().toISOString().split('T')[0];
    let totalHoy = 0;

compras.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${c.fecha}</td>
        <td>${c.proveedor_nombre}</td>
        <td>${c.producto_nombre}</td>
        <td>${c.cantidad}</td>
        <td>
            <input type="number" value="${c.precio_compra}" data-id="${c.id}">
            <button onclick="guardarPrecioCompra(this)">‚úèÔ∏è</button>
        </td>
    `;
    tbody.appendChild(tr);

        // Total del d√≠a
        const fechaRegistro = new Date(c.fecha).toISOString().split('T')[0];
        if (fechaRegistro === hoy) {
            const precio = parseFloat(c.precio_compra) || 0;
            const cantidad = parseInt(c.cantidad) || 0;
            totalHoy += precio * cantidad;
        }
    });

    document.getElementById('totalHoy').textContent =
        `Total de compras hoy: $${totalHoy.toFixed(2)}`;
}

async function guardarPrecioCompra(button) {
    const input = button.previousElementSibling;
    const nuevoPrecio = parseFloat(input.value);
    const id = input.dataset.id;

    if (isNaN(nuevoPrecio) || nuevoPrecio <= 0) {
        alert("El precio debe ser v√°lido");
        return;
    }

    try {
        const res = await fetch(`/compras/${id}/precio`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, precio_compra: parseFloat(nuevoPrecio) })
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
            await cargarCompras(); // refresca la tabla
        }
    } catch (err) {
        console.error("Error al actualizar precio:", err);
        alert("Error al actualizar precio");
    }
}

async function editarPrecio(id, precioActual) {
    const nuevoPrecio = prompt("Nuevo precio:", precioActual);
    if (!nuevoPrecio) return;

    try {
        const res = await fetch(`/compras/${id}/precio`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ precio_compra: parseFloat(nuevoPrecio) })
        });
        const msg = await res.text();
        alert(msg);
        cargarCompras();
    } catch (err) {
        console.error('Error al actualizar precio:', err);
        alert('Error al actualizar precio');
    }
}




document.getElementById('agregarCompra').onclick = async function() {
    const proveedor = document.getElementById('proveedorSelect').value;
    const producto = document.getElementById('productoSelect').value;
    const cantidad = parseInt(document.getElementById('cantidad').value);
    const precioCompra = parseFloat(document.getElementById('precioCompra').value);

    if (!proveedor || !producto || !cantidad || !precioCompra) {
        alert('Completa todos los campos');
        return;
    }

    // Guardar valores en localStorage para mantenerlos tras el reload
    localStorage.setItem('cantidadCompra', cantidad);
    localStorage.setItem('precioCompra', precioCompra);

    try {
        const res = await fetch('/compras', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                proveedor,
                producto,
                cantidad,
                precio_compra: precioCompra
            })
        });

        const msg = await res.text();
        alert(msg);

        // üîπ Esperar un breve momento y refrescar
        setTimeout(() => {
            location.reload();
        }, 200); // un peque√±o delay por seguridad

    } catch (err) {
        console.error('Error al registrar compra:', err);
        alert('Ocurri√≥ un error al registrar la compra');
    }
};


    document.getElementById('buscarProducto').addEventListener('input', function() {
        renderSelectProductos(this.value.trim());
    });

    // Restaurar cantidad y precio al cargar
    window.addEventListener('DOMContentLoaded', () => {
        const cantidadGuardada = localStorage.getItem('cantidadCompra');
        const precioGuardado = localStorage.getItem('precioCompra');

        if (cantidadGuardada) {
            document.getElementById('cantidad').value = cantidadGuardada;
        }
        if (precioGuardado) {
            document.getElementById('precioCompra').value = precioGuardado;
        }
    });

    cargarProveedores();
    cargarProductos();
    cargarCompras();
</script>

</body>
</html>