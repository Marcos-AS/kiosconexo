<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lista de Compras</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .sugerencias {
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background: #fff;
            z-index: 10;
            width: 300px;
        }
        .sugerencia-item {
            padding: 5px;
            cursor: pointer;
        }
        .sugerencia-item:hover {
            background: #eee;
        }
        #form-agregar { position: relative; }
    </style>
</head>
<body>
    <h1>Lista de Compras</h1>
    <form id="form-agregar" autocomplete="off">
        <label for="nombreProducto">Nombre del producto:</label>
        <input type="text" id="nombreProducto" required autocomplete="off" style="width:300px;">
        <div id="sugerencias" class="sugerencias"></div>
        <button type="submit">Agregar</button>
    </form>
    <table border="1" id="tabla-compras">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Gramos</th>
                <th>Quitar</th>
            </tr>
        </thead>
        <tbody id="lista-compras"></tbody>
    </table>
    <br>
    <button id="btn-pdf">Exportar a PDF</button>

    <script>
        const lista = [];
        const tbody = document.getElementById('lista-compras');
        const form = document.getElementById('form-agregar');
        const input = document.getElementById('nombreProducto');
        const sugerenciasDiv = document.getElementById('sugerencias');

        // Mostrar sugerencias al escribir
        input.addEventListener('input', async () => {
            const texto = input.value.trim();
            if (texto.length < 1) {
                sugerenciasDiv.innerHTML = '';
                return;
            }
            const res = await fetch(`/productos?nombre=${encodeURIComponent(texto)}`);
            const productos = await res.json();
            sugerenciasDiv.innerHTML = '';
            productos.forEach(prod => {
                const div = document.createElement('div');
                div.className = 'sugerencia-item';
                div.textContent = `${prod.nombre} (${prod.categoria_nombre || ''}, ${prod.gramos || ''}g)`;
                div.onclick = () => {
                    agregarProducto(prod);
                    sugerenciasDiv.innerHTML = '';
                    //input.value = '';
                    input.focus();
                };
                sugerenciasDiv.appendChild(div);
            });
        });

        // Ocultar sugerencias si se hace click fuera
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !sugerenciasDiv.contains(e.target)) {
                sugerenciasDiv.innerHTML = '';
            }
        });

        function agregarProducto(prod) {
            if (lista.find(p => p.ean === prod.ean)) {
                alert('Ya está en la lista');
                return;
            }
            lista.push(prod);
            renderLista();
        }

        function renderLista() {
            tbody.innerHTML = '';
            lista.forEach((prod, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${prod.nombre}</td>
                    <td>${prod.categoria_nombre || ''}</td>
                    <td>${prod.gramos || ''}</td>
                    <td><button onclick="quitarProducto(${idx})">Quitar</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.quitarProducto = function(idx) {
            lista.splice(idx, 1);
            renderLista();
        }

        // Si el usuario envía el form, intenta agregar el primero de la búsqueda exacta
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = input.value.trim();
            if (!nombre) return;
            const res = await fetch(`/productos?nombre=${encodeURIComponent(nombre)}`);
            const productos = await res.json();
            const prod = productos.find(p => p.nombre.toLowerCase() === nombre.toLowerCase()) || productos[0];
            if (!prod) {
                alert('Producto no encontrado');
                return;
            }
            agregarProducto(prod);
            sugerenciasDiv.innerHTML = '';
            input.value = '';
            input.focus();
        });

        document.getElementById('btn-pdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Lista de Compras', 10, 10);
            let y = 20;
            lista.forEach((prod, i) => {
                doc.text(`${i + 1}. ${prod.nombre} | ${prod.categoria_nombre || ''} | ${prod.gramos || ''}g`, 10, y);
                y += 10;
            });
            doc.save('lista-compras.pdf');
        });
    </script>
</body>
</html>