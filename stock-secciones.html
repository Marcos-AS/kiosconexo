<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock por Secciones - Kiosco Nexo</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .container-seccion {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .titulo-seccion {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }

        .tabla-productos {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: white;
        }

        .tabla-productos thead {
            background-color: #0066cc;
            color: white;
        }

        .tabla-productos th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #0066cc;
        }

        .tabla-productos td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tabla-productos tbody tr:hover {
            background-color: #f5f5f5;
        }

        .stock-bajo {
            background-color: #ffe6e6;
            font-weight: 600;
            color: #d32f2f;
        }

        .stock-medio {
            background-color: #fff3cd;
            font-weight: 600;
            color: #856404;
        }

        .stock-bien {
            background-color: #d4edda;
            font-weight: 600;
            color: #155724;
        }

        .categoria-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .marca-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            background-color: #f3e5f5;
            color: #6a1b9a;
        }

        .precio {
            font-weight: 600;
            color: #2e7d32;
        }

        .proveedor {
            color: #555;
            font-size: 0.9rem;
        }

        .spinner {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }

        .error-message {
            background-color: #ffcdd2;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .resumen {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .card-resumen {
            background: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 200px;
        }

        .card-resumen h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .card-resumen .valor {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0066cc;
        }

        @media print {
            body {
                background: white;
            }
            .container-seccion {
                max-width: 100%;
                padding: 10px;
            }
            .tabla-productos {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            .tabla-productos thead {
                background-color: #e0e0e0;
                color: #333;
            }
            button {
                display: none !important;
            }
            #selectorSeccion {
                display: none !important;
            }
            .titulo-seccion {
                page-break-after: avoid;
            }
            .tabla-productos tr {
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .tabla-productos {
                font-size: 0.9rem;
            }

            .tabla-productos th,
            .tabla-productos td {
                padding: 8px 10px;
            }

            .titulo-seccion {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-seccion">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 class="titulo-seccion" style="margin: 0; flex: 1;">üì¶ <span id="nombreSeccion">Heladera Blanca</span></h1>
            <div style="display: flex; gap: 15px; align-items: flex-end;">
                <div>
                    <label for="selectorSeccion" style="font-weight: 600; color: #333; margin-right: 10px;">Cambiar secci√≥n:</label>
                    <select id="selectorSeccion" style="padding: 10px; border: 2px solid #0066cc; border-radius: 4px; font-size: 1rem; cursor: pointer;">
                        <option value="heladera-blanca">Heladera Blanca</option>
                        <option value="heladera-coca-cola">Heladera Coca Cola</option>
                        <option value="mostrador-golosinas">Mostrador Golosinas</option>
                        <option value="mostrador-chocolates">Mostrador Chocolates</option>
                        <option value="isla-galletas">Isla Galletas</option>
                        <option value="estanteria-snacks">Estanter√≠a Snacks</option>
                        <option value="cigarrillos">Cigarrillos</option>
                    </select>
                </div>
                <button onclick="imprimirPDF()" style="padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">üñ®Ô∏è Imprimir PDF</button>
                <button onclick="descargarPDFTodasSecciones()" style="padding: 10px 15px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">üìã Descargar Todas</button>
            </div>
        </div>
        
        <div id="resumen" class="resumen"></div>
        
        <div style="background: white; padding: 15px; border-radius: 4px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
            <h3 style="margin-top: 0; color: #333;">Filtros</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                <div>
                    <label for="filtroCategoria" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Categor√≠a:</label>
                    <select id="filtroCategoria" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
                <div>
                    <label for="filtroProveedor" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Lugar de Compra:</label>
                    <select id="filtroProveedor" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                        <option value="">Todos los proveedores</option>
                    </select>
                </div>
                <div>
                    <label for="ordenStock" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Ordenar por:</label>
                    <select id="ordenStock" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                        <option value="original">Sin ordenamiento</option>
                        <option value="bajo-alto">Stock (Menor a Mayor)</option>
                        <option value="alto-bajo">Stock (Mayor a Menor)</option>
                    </select>
                </div>
                <button onclick="limpiarFiltros()" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Limpiar Filtros</button>
            </div>
        </div>

        <div id="cargando" class="spinner" style="display: none;">Cargando datos...</div>
        <div id="error" class="error-message" style="display: none;"></div>

        <table class="tabla-productos" id="tablaProductos">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Categor√≠a</th>
                    <th>Marca</th>
                    <th>Stock</th>
                    <th>Precio Venta</th>
                    <th>Precio Compra</th>
                    <th>Lugar de Compra</th>
                </tr>
            </thead>
            <tbody id="tbody-productos">
            </tbody>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        let productosOriginales = [];
        const nombresSeccion = {
            'heladera-blanca': 'Heladera Blanca',
            'heladera-coca-cola': 'Heladera Coca Cola',
            'mostrador-golosinas': 'Mostrador Golosinas',
            'mostrador-chocolates': 'Mostrador Chocolates',
            'isla-galletas': 'Isla Galletas',
            'estanteria-snacks': 'Estanter√≠a Snacks',
            'cigarrillos': 'Cigarrillos'
        };

        async function cargarStockSeccion(seccion) {
            const cargandoDiv = document.getElementById('cargando');
            const errorDiv = document.getElementById('error');
            const tbody = document.getElementById('tbody-productos');
            const resumenDiv = document.getElementById('resumen');
            const nombreSeccionSpan = document.getElementById('nombreSeccion');

            // Actualizar t√≠tulo
            nombreSeccionSpan.textContent = nombresSeccion[seccion] || 'Desconocida';

            cargandoDiv.style.display = 'block';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`/stock-seccion/${seccion}`);
                if (!response.ok) throw new Error('Error al obtener datos');

                let productos = await response.json();
                
                // Filtrar productos con stock null o undefined
                productos = productos.filter(p => p.stock !== null && p.stock !== undefined);
                
                productosOriginales = productos;
                cargandoDiv.style.display = 'none';

                if (productos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No hay productos en esta secci√≥n</td></tr>';
                    return;
                }

                // Llenar selectores de filtro
                const categorias = [...new Set(productos.map(p => p.categoria))].sort();
                const proveedores = [...new Set(productos.map(p => p.proveedor))].sort();

                const selectCategoria = document.getElementById('filtroCategoria');
                const selectProveedor = document.getElementById('filtroProveedor');

                // Limpiar opciones previas (excepto la primera)
                while (selectCategoria.options.length > 1) {
                    selectCategoria.remove(1);
                }
                while (selectProveedor.options.length > 1) {
                    selectProveedor.remove(1);
                }

                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    selectCategoria.appendChild(option);
                });

                proveedores.forEach(prov => {
                    const option = document.createElement('option');
                    option.value = prov;
                    option.textContent = prov;
                    selectProveedor.appendChild(option);
                });

                // Mostrar todos los productos
                mostrarProductos(productos);

            } catch (error) {
                cargandoDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error al cargar los datos: ' + error.message;
                console.error(error);
            }
        }

        function mostrarProductos(productos) {
            const tbody = document.getElementById('tbody-productos');
            const resumenDiv = document.getElementById('resumen');

            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No hay productos que coincidan con los filtros</td></tr>';
                resumenDiv.innerHTML = '';
                return;
            }

            // Calcular resumen
            const totalStock = productos.reduce((sum, p) => sum + p.stock, 0);
            const cantidadProductos = productos.length;
            const productosConStock = productos.filter(p => p.stock > 0).length;
            const productosConStockBajo = productos.filter(p => p.stock < 3).length;

            resumenDiv.innerHTML = `
                <div class="card-resumen">
                    <h3>Total de Productos</h3>
                    <div class="valor">${cantidadProductos}</div>
                </div>
                <div class="card-resumen">
                    <h3>Stock Total</h3>
                    <div class="valor">${totalStock}</div>
                </div>
                <div class="card-resumen">
                    <h3>Productos con Stock</h3>
                    <div class="valor">${productosConStock}</div>
                </div>
                <div class="card-resumen">
                    <h3>Stock Bajo (&lt;3)</h3>
                    <div class="valor" style="color: #d32f2f;">${productosConStockBajo}</div>
                </div>
            `;

            // Llenar tabla
            tbody.innerHTML = productos.map(prod => {
                let claseStock = 'stock-bien';
                if (prod.stock < 3) {
                    claseStock = 'stock-bajo';
                } else if (prod.stock < 5) {
                    claseStock = 'stock-medio';
                }

                return `
                    <tr>
                        <td><strong>${prod.nombre}</strong></td>
                        <td><span class="categoria-badge">${prod.categoria}</span></td>
                        <td><span class="marca-badge">${prod.marca}</span></td>
                        <td class="${claseStock}">${prod.stock}</td>
                        <td class="precio">$${prod.precio_venta || 'N/A'}</td>
                        <td class="precio">$${prod.precio_compra && !isNaN(prod.precio_compra) ? parseFloat(prod.precio_compra).toFixed(2) : 'N/A'}</td>
                        <td class="proveedor">${prod.proveedor}</td>
                    </tr>
                `;
            }).join('');
        }

        function aplicarFiltros() {
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            const filtroProveedor = document.getElementById('filtroProveedor').value;
            const ordenStock = document.getElementById('ordenStock').value;

            let productosFiltrados = productosOriginales;

            if (filtroCategoria) {
                productosFiltrados = productosFiltrados.filter(p => p.categoria === filtroCategoria);
            }

            if (filtroProveedor) {
                productosFiltrados = productosFiltrados.filter(p => p.proveedor === filtroProveedor);
            }

            // Aplicar ordenamiento
            if (ordenStock === 'bajo-alto') {
                productosFiltrados = [...productosFiltrados].sort((a, b) => a.stock - b.stock);
            } else if (ordenStock === 'alto-bajo') {
                productosFiltrados = [...productosFiltrados].sort((a, b) => b.stock - a.stock);
            }

            mostrarProductos(productosFiltrados);
        }

        function limpiarFiltros() {
            document.getElementById('filtroCategoria').value = '';
            document.getElementById('filtroProveedor').value = '';
            document.getElementById('ordenStock').value = 'original';
            mostrarProductos(productosOriginales);
        }

        function imprimirPDF() {
            window.print();
        }

        async function descargarPDFTodasSecciones() {
            const seccionesInfo = [
                { id: 'heladera-blanca', nombre: 'Heladera Blanca' },
                { id: 'heladera-coca-cola', nombre: 'Heladera Coca Cola' },
                { id: 'mostrador-golosinas', nombre: 'Mostrador Golosinas' },
                { id: 'mostrador-chocolates', nombre: 'Mostrador Chocolates' },
                { id: 'isla-galletas', nombre: 'Isla Galletas' },
                { id: 'estanteria-snacks', nombre: 'Estanter√≠a Snacks' },
                { id: 'cigarrillos', nombre: 'Cigarrillos' }
            ];

            // Crear un elemento div para contener todo el contenido
            const contenedorPDF = document.createElement('div');
            contenedorPDF.style.padding = '20px';
            contenedorPDF.style.fontFamily = 'Arial, sans-serif';
            contenedorPDF.style.backgroundColor = '#fff';

            // Agregar t√≠tulo
            const titulo = document.createElement('h1');
            titulo.style.textAlign = 'center';
            titulo.style.borderBottom = '3px solid #0066cc';
            titulo.style.paddingBottom = '10px';
            titulo.textContent = 'Stock de Todas las Secciones';
            contenedorPDF.appendChild(titulo);

            // Agregar fecha
            const fecha = document.createElement('p');
            fecha.style.textAlign = 'center';
            fecha.style.color = '#666';
            fecha.style.marginBottom = '30px';
            fecha.textContent = `Generado el: ${new Date().toLocaleString('es-AR')}`;
            contenedorPDF.appendChild(fecha);

            // Cargar datos de cada secci√≥n
            for (const seccion of seccionesInfo) {
                try {
                    const response = await fetch(`/stock-seccion/${seccion.id}`);
                    if (!response.ok) continue;

                    let productos = await response.json();
                    productos = productos.filter(p => p.stock !== null && p.stock !== undefined);

                    if (productos.length === 0) continue;

                    // Ordenar productos por stock (menor a mayor)
                    productos.sort((a, b) => a.stock - b.stock);

                    // Crear encabezado de secci√≥n
                    const encabezado = document.createElement('h2');
                    encabezado.style.marginTop = '30px';
                    encabezado.style.marginBottom = '15px';
                    encabezado.style.color = '#0066cc';
                    encabezado.style.borderBottom = '2px solid #0066cc';
                    encabezado.style.paddingBottom = '10px';
                    encabezado.textContent = 'üì¶ ' + seccion.nombre;
                    contenedorPDF.appendChild(encabezado);

                    // Crear tabla
                    const tabla = document.createElement('table');
                    tabla.style.width = '100%';
                    tabla.style.borderCollapse = 'collapse';
                    tabla.style.marginBottom = '20px';
                    tabla.style.fontSize = '12px';

                    // Headers
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    headerRow.style.backgroundColor = '#0066cc';
                    headerRow.style.color = 'white';

                    const headers = ['Producto', 'Categor√≠a', 'Marca', 'Stock', 'Precio Venta', 'Precio Compra', 'Lugar de Compra'];
                    headers.forEach(h => {
                        const th = document.createElement('th');
                        th.style.padding = '10px';
                        th.style.textAlign = 'left';
                        th.style.borderBottom = '2px solid #0066cc';
                        th.style.fontWeight = 'bold';
                        th.textContent = h;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    tabla.appendChild(thead);

                    // Body
                    const tbody = document.createElement('tbody');
                    productos.forEach((prod, idx) => {
                        const row = document.createElement('tr');
                        row.style.backgroundColor = idx % 2 === 0 ? '#fff' : '#f9f9f9';
                        row.style.borderBottom = '1px solid #e0e0e0';

                        let stockColor = '#155724'; // verde
                        if (prod.stock < 3) {
                            stockColor = '#d32f2f'; // rojo
                        } else if (prod.stock < 5) {
                            stockColor = '#856404'; // naranja
                        }

                        const cells = [
                            prod.nombre,
                            prod.categoria,
                            prod.marca,
                            prod.stock,
                            `$${prod.precio_venta || 'N/A'}`,
                            `$${prod.precio_compra && !isNaN(prod.precio_compra) ? parseFloat(prod.precio_compra).toFixed(2) : 'N/A'}`,
                            prod.proveedor
                        ];

                        cells.forEach((cell, idx) => {
                            const td = document.createElement('td');
                            td.style.padding = '8px 10px';
                            td.style.borderRight = '1px solid #e0e0e0';
                            if (idx === 3) { // columna Stock
                                td.style.fontWeight = 'bold';
                                td.style.color = stockColor;
                            }
                            td.textContent = cell;
                            row.appendChild(td);
                        });
                        tbody.appendChild(row);
                    });
                    tabla.appendChild(tbody);
                    contenedorPDF.appendChild(tabla);

                } catch (error) {
                    console.error(`Error cargando secci√≥n ${seccion.id}:`, error);
                }
            }

            // Generar PDF usando html2pdf
            const opt = {
                margin: 10,
                filename: `stock-todas-secciones-${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'landscape', unit: 'mm', format: 'a4' }
            };

            html2pdf().set(opt).from(contenedorPDF).save();
        }

        function imprimirPDF() {
            window.print();
        }

        // Cambiar de secci√≥n
        document.getElementById('selectorSeccion').addEventListener('change', function() {
            cargarStockSeccion(this.value);
        });

        // Cargar datos al abrir la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            const selectorSeccion = document.getElementById('selectorSeccion');
            cargarStockSeccion(selectorSeccion.value);

            // Agregar listeners a los filtros
            document.getElementById('filtroCategoria').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroProveedor').addEventListener('change', aplicarFiltros);
            document.getElementById('ordenStock').addEventListener('change', aplicarFiltros);
        });
    </script>
</body>
</html>
