<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock por Secciones - Kiosco Nexo</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .container-seccion {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .titulo-seccion {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }

        .tabla-productos {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: white;
        }

        .tabla-productos thead {
            background-color: #0066cc;
            color: white;
        }

        .tabla-productos th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #0066cc;
        }

        .tabla-productos td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tabla-productos tbody tr:hover {
            background-color: #f5f5f5;
        }

        .stock-bajo {
            background-color: #ffe6e6;
            font-weight: 600;
            color: #d32f2f;
        }

        .stock-medio {
            background-color: #fff3cd;
            font-weight: 600;
            color: #856404;
        }

        .stock-bien {
            background-color: #d4edda;
            font-weight: 600;
            color: #155724;
        }

        .categoria-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .marca-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            background-color: #f3e5f5;
            color: #6a1b9a;
        }

        .precio {
            font-weight: 600;
            color: #2e7d32;
        }

        .proveedor {
            color: #555;
            font-size: 0.9rem;
        }

        .spinner {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }

        .error-message {
            background-color: #ffcdd2;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .resumen {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .card-resumen {
            background: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 200px;
        }

        .card-resumen h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .card-resumen .valor {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0066cc;
        }

        @media (max-width: 768px) {
            .tabla-productos {
                font-size: 0.9rem;
            }

            .tabla-productos th,
            .tabla-productos td {
                padding: 8px 10px;
            }

            .titulo-seccion {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-seccion">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 class="titulo-seccion" style="margin: 0; flex: 1;">游닍 <span id="nombreSeccion">Heladera Blanca</span></h1>
            <div>
                <label for="selectorSeccion" style="font-weight: 600; color: #333; margin-right: 10px;">Cambiar secci칩n:</label>
                <select id="selectorSeccion" style="padding: 10px; border: 2px solid #0066cc; border-radius: 4px; font-size: 1rem; cursor: pointer;">
                    <option value="heladera-blanca">Heladera Blanca</option>
                    <option value="heladera-coca-cola">Heladera Coca Cola</option>
                    <option value="mostrador-golosinas">Mostrador Golosinas</option>
                </select>
            </div>
        </div>
        
        <div id="resumen" class="resumen"></div>
        
        <div style="background: white; padding: 15px; border-radius: 4px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
            <h3 style="margin-top: 0; color: #333;">Filtros</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                <div>
                    <label for="filtroCategoria" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Categor칤a:</label>
                    <select id="filtroCategoria" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                        <option value="">Todas las categor칤as</option>
                    </select>
                </div>
                <div>
                    <label for="filtroProveedor" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Lugar de Compra:</label>
                    <select id="filtroProveedor" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                        <option value="">Todos los proveedores</option>
                    </select>
                </div>
                <button onclick="limpiarFiltros()" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Limpiar Filtros</button>
            </div>
        </div>

        <div id="cargando" class="spinner" style="display: none;">Cargando datos...</div>
        <div id="error" class="error-message" style="display: none;"></div>

        <table class="tabla-productos" id="tablaProductos">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Categor칤a</th>
                    <th>Marca</th>
                    <th>Stock</th>
                    <th>Precio Venta</th>
                    <th>Precio Compra</th>
                    <th>Lugar de Compra</th>
                </tr>
            </thead>
            <tbody id="tbody-productos">
            </tbody>
        </table>
    </div>

    <script>
        let productosOriginales = [];
        const nombresSeccion = {
            'heladera-blanca': 'Heladera Blanca',
            'heladera-coca-cola': 'Heladera Coca Cola',
            'mostrador-golosinas': 'Mostrador Golosinas'
        };

        async function cargarStockSeccion(seccion) {
            const cargandoDiv = document.getElementById('cargando');
            const errorDiv = document.getElementById('error');
            const tbody = document.getElementById('tbody-productos');
            const resumenDiv = document.getElementById('resumen');
            const nombreSeccionSpan = document.getElementById('nombreSeccion');

            // Actualizar t칤tulo
            nombreSeccionSpan.textContent = nombresSeccion[seccion] || 'Desconocida';

            cargandoDiv.style.display = 'block';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`/stock-seccion/${seccion}`);
                if (!response.ok) throw new Error('Error al obtener datos');

                let productos = await response.json();
                
                // Filtrar productos con stock null o undefined
                productos = productos.filter(p => p.stock !== null && p.stock !== undefined);
                
                productosOriginales = productos;
                cargandoDiv.style.display = 'none';

                if (productos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No hay productos en esta secci칩n</td></tr>';
                    return;
                }

                // Llenar selectores de filtro
                const categorias = [...new Set(productos.map(p => p.categoria))].sort();
                const proveedores = [...new Set(productos.map(p => p.proveedor))].sort();

                const selectCategoria = document.getElementById('filtroCategoria');
                const selectProveedor = document.getElementById('filtroProveedor');

                // Limpiar opciones previas (excepto la primera)
                while (selectCategoria.options.length > 1) {
                    selectCategoria.remove(1);
                }
                while (selectProveedor.options.length > 1) {
                    selectProveedor.remove(1);
                }

                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    selectCategoria.appendChild(option);
                });

                proveedores.forEach(prov => {
                    const option = document.createElement('option');
                    option.value = prov;
                    option.textContent = prov;
                    selectProveedor.appendChild(option);
                });

                // Mostrar todos los productos
                mostrarProductos(productos);

            } catch (error) {
                cargandoDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error al cargar los datos: ' + error.message;
                console.error(error);
            }
        }

        function mostrarProductos(productos) {
            const tbody = document.getElementById('tbody-productos');
            const resumenDiv = document.getElementById('resumen');

            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No hay productos que coincidan con los filtros</td></tr>';
                resumenDiv.innerHTML = '';
                return;
            }

            // Calcular resumen
            const totalStock = productos.reduce((sum, p) => sum + p.stock, 0);
            const cantidadProductos = productos.length;
            const productosConStock = productos.filter(p => p.stock > 0).length;
            const productosConStockBajo = productos.filter(p => p.stock < 3).length;

            resumenDiv.innerHTML = `
                <div class="card-resumen">
                    <h3>Total de Productos</h3>
                    <div class="valor">${cantidadProductos}</div>
                </div>
                <div class="card-resumen">
                    <h3>Stock Total</h3>
                    <div class="valor">${totalStock}</div>
                </div>
                <div class="card-resumen">
                    <h3>Productos con Stock</h3>
                    <div class="valor">${productosConStock}</div>
                </div>
                <div class="card-resumen">
                    <h3>Stock Bajo (&lt;3)</h3>
                    <div class="valor" style="color: #d32f2f;">${productosConStockBajo}</div>
                </div>
            `;

            // Llenar tabla
            tbody.innerHTML = productos.map(prod => {
                let claseStock = 'stock-bien';
                if (prod.stock < 3) {
                    claseStock = 'stock-bajo';
                } else if (prod.stock < 5) {
                    claseStock = 'stock-medio';
                }

                return `
                    <tr>
                        <td><strong>${prod.nombre}</strong></td>
                        <td><span class="categoria-badge">${prod.categoria}</span></td>
                        <td><span class="marca-badge">${prod.marca}</span></td>
                        <td class="${claseStock}">${prod.stock}</td>
                        <td class="precio">$${prod.precio_venta || 'N/A'}</td>
                        <td class="precio">$${prod.precio_compra && !isNaN(prod.precio_compra) ? parseFloat(prod.precio_compra).toFixed(2) : 'N/A'}</td>
                        <td class="proveedor">${prod.proveedor}</td>
                    </tr>
                `;
            }).join('');
        }

        function aplicarFiltros() {
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            const filtroProveedor = document.getElementById('filtroProveedor').value;

            let productosFiltrados = productosOriginales;

            if (filtroCategoria) {
                productosFiltrados = productosFiltrados.filter(p => p.categoria === filtroCategoria);
            }

            if (filtroProveedor) {
                productosFiltrados = productosFiltrados.filter(p => p.proveedor === filtroProveedor);
            }

            mostrarProductos(productosFiltrados);
        }

        function limpiarFiltros() {
            document.getElementById('filtroCategoria').value = '';
            document.getElementById('filtroProveedor').value = '';
            mostrarProductos(productosOriginales);
        }

        // Cambiar de secci칩n
        document.getElementById('selectorSeccion').addEventListener('change', function() {
            cargarStockSeccion(this.value);
        });

        // Cargar datos al abrir la p치gina
        document.addEventListener('DOMContentLoaded', () => {
            const selectorSeccion = document.getElementById('selectorSeccion');
            cargarStockSeccion(selectorSeccion.value);

            // Agregar listeners a los filtros
            document.getElementById('filtroCategoria').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroProveedor').addEventListener('change', aplicarFiltros);
        });
    </script>
</body>
</html>
