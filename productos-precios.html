<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Precios y Ventas de Productos por Categoría</title>
    <style>
        body {
            font-family: sans-serif;
            background: #fafafa;
        }
        h2 {
            text-align: center;
        }
        .categoria {
            margin: 20px auto;
            width: 90%;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .categoria-header {
            cursor: pointer;
            background: #4CAF50;
            color: white;
            padding: 10px 15px;
            font-size: 1.1em;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .categoria-header:hover {
            background: #45a049;
        }
        .tabla-contenido {
            display: none;
            overflow: hidden;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: center;
        }
        th {
            background: #f5f5f5;
        }
        .bajo-porcentaje { background: #ffdddd; }
        .sin-stock { background: #ffe5b4; }
        .venta-baja { background: #fff3cd; }
        .producto-top { background: #d4edda; }
        .flecha {
            transition: transform 0.2s;
        }
        .flecha.abierto {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <h2>Precios y Ventas de Productos por Categoría</h2>
    <div id="contenedor-categorias"></div>

    <script>
        const GASTOS_FIJOS = 500000;
        const VENTAS_MES = 1794000;
        const MARGEN_OBJETIVO = 0.4;
        const factorGastos = GASTOS_FIJOS / VENTAS_MES;
        const factorTotal = 1 + MARGEN_OBJETIVO + factorGastos;

        async function cargarDatosCombinados() {
            const [resPrecios, resVentas] = await Promise.all([
                fetch('/productos-precios'),
                fetch('/top-productos-vendidos-por-categoria')
            ]);

            const precios = await resPrecios.json();
            const ventas = await resVentas.json();
            const mapaVentas = {};
            ventas.forEach(v => { mapaVentas[v.nombre.trim()] = v.total_vendido; });

            // Agrupar por categoría
            const categorias = {};
            precios.forEach(prod => {
                if (!categorias[prod.categoria]) categorias[prod.categoria] = [];
                categorias[prod.categoria].push(prod);
            });

            const contenedor = document.getElementById('contenedor-categorias');
            contenedor.innerHTML = '';

            const categoriasOrdenadas = Object.keys(categorias).sort((a, b) => 
                a.localeCompare(b, 'es', { sensitivity: 'base' })
            );

            categoriasOrdenadas.forEach(categoria => {
                const productos = categorias[categoria];

                productos.sort((a, b) => {
                    const ventasA = mapaVentas[a.nombre.trim()] || 0;
                    const ventasB = mapaVentas[b.nombre.trim()] || 0;
                    return ventasB - ventasA;
                });

                const divCat = document.createElement('div');
                divCat.className = 'categoria';

                const header = document.createElement('div');
                header.className = 'categoria-header';
                header.innerHTML = `
                    <span>${categoria}</span>
                    <span class="flecha">▶</span>
                `;

                const contenido = document.createElement('div');
                contenido.className = 'tabla-contenido';

                const tabla = document.createElement('table');
                tabla.innerHTML = `
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Precio Venta</th>
                            <th>Precio Compra</th>
                            <th>Rentabilidad (%)</th>
                            <th>Diferencia (%)</th>
                            <th>Precio 40%</th>
                            <th>Precio Sugerido</th>
                            <th>Cant. Vendida</th>
                            <th>Última Compra</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = tabla.querySelector('tbody');

                productos.forEach(prod => {
                    const precioVenta = parseFloat(prod.precio_venta);
                    const precioCompra = parseFloat(prod.precio_compra);
                    let precio40 = '-';
                    let diferenciaPrecio = null;
                    let precioSugerido = '-';

                    if (!isNaN(precioCompra) && precioCompra > 0) {
                        precio40 = (precioCompra * 1.4).toFixed(2);
                        diferenciaPrecio = parseFloat(precio40) - precioVenta;
                        precioSugerido = (precioCompra * factorTotal).toFixed(2);
                    }

                    let rentabilidad = '-';
                    if (!isNaN(precioVenta) && precioVenta > 0 && !isNaN(precioCompra) && precioCompra > 0) {
                        const ganancia = precioVenta - precioCompra;
                        rentabilidad = ((ganancia / precioVenta) * 100).toFixed(2) + '%';
                    }

                    const cantidadVendida = mapaVentas[prod.nombre.trim()] || 0;

                    const tr = document.createElement('tr');
                    let marcarRojo = false;

                    if (prod.categoria === 'Cigarrillos') {
                        marcarRojo = false;
                    } else if (
                        (prod.categoria === 'Snack salado' || prod.categoria === 'Papitas') &&
                        !isNaN(prod.diferencia) &&
                        prod.diferencia < 30 &&
                        diferenciaPrecio !== null &&
                        diferenciaPrecio > 50
                    ) {
                        marcarRojo = true;
                    } else if (
                        prod.categoria !== 'Cigarrillos' &&
                        prod.categoria !== 'Snack salado' &&
                        prod.categoria !== 'Palitos salados' &&
                        prod.categoria !== 'Chisitos' &&
                        prod.categoria !== 'Nachos' &&
                        prod.categoria !== 'Papitas' &&
                        !isNaN(prod.diferencia) &&
                        prod.diferencia < 40 &&
                        diferenciaPrecio !== null &&
                        diferenciaPrecio > 50
                    ) {
                        marcarRojo = true;
                    }

                    if (!isNaN(precioVenta) && !isNaN(precioSugerido) && (precioSugerido - precioVenta) > 100) {
                        if (cantidadVendida < 50) {
                            tr.classList.add('venta-baja');
                        }
                    }

                    if (cantidadVendida > 200) {
                        tr.classList.add('producto-top');
                    }

                    if (marcarRojo) {
                        if (prod.stock === 0) {
                            tr.classList.add('sin-stock');
                        } else {
                            tr.classList.add('bajo-porcentaje');
                        }
                    }

                     const fechaCompra = prod.fecha_ultima_compra 
                        ? new Date(prod.fecha_ultima_compra).toLocaleDateString('es-AR')
                        : '-';

                    tr.innerHTML = `
                        <td>${prod.nombre}</td>
                        <td>${precioVenta ?? '-'}</td>
                        <td>${precioCompra ?? '-'}</td>
                        <td>${rentabilidad}</td>
                        <td>${prod.diferencia !== null ? prod.diferencia + '%' : '-'}</td>
                        <td>${precio40}</td>
                        <td>${precioSugerido}</td>
                        <td>${cantidadVendida}</td>
                        <td>${fechaCompra}</td>
                    `;
                    tbody.appendChild(tr);
                });

                contenido.appendChild(tabla);
                divCat.appendChild(header);
                divCat.appendChild(contenido);
                contenedor.appendChild(divCat);

                header.addEventListener('click', () => {
                    const flecha = header.querySelector('.flecha');
                    const abierto = contenido.style.display === 'block';
                    contenido.style.display = abierto ? 'none' : 'block';
                    flecha.classList.toggle('abierto', !abierto);
                });
            });
        }

        cargarDatosCombinados();
    </script>
</body>
</html>
