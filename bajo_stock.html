<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Productos con Bajo Stock</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .categoria-titulo { font-weight: bold; color: #2a5d9f; margin-top: 1.5em; }
        .stock-titulo { font-weight: bold; margin-top: 1em; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #f5f5f5; }
        .ocultar-btn { font-size: 12px; margin-left: 8px; }
        .mostrar-btn { font-size: 12px; margin-bottom: 10px; }
        .stock-2 { background: #fffde7; }
        .stock-1 { background: #fff3e0; }
        .stock-0 { background: #ffebee; }
        .filtros { margin-bottom: 1em; }
    </style>
</head>
<body>
    <h1>Productos con Bajo Stock</h1>

    <div class="filtros">
        <label for="filtroMarcaBajoStock">
            Filtrar por marca:
            <select id="filtroMarcaBajoStock">
                <option value="">-- Todas las marcas --</option>
            </select>
        </label>

        <label for="filtroStock" style="margin-left: 1em;">
            Filtrar por stock:
            <select id="filtroStock">
                <option value="">-- Todos --</option>
                <option value="2">2</option>
                <option value="1">1</option>
                <option value="0">0</option>
            </select>
        </label>

        <button id="btn-exportar-pdf">Exportar visibles a PDF</button>
        <button id="btn-mostrar-todos" class="mostrar-btn">Mostrar todos</button>
    </div>

    <div id="contenedor-bajo-stock"></div>

    <script>
        let productosVisibles = [];
        let productosOriginales = [];

        async function cargarProductosBajoStock() {
            const res = await fetch('/productos-bajo-stock');
            let productos = await res.json();
            productosOriginales = productos.map(p => ({ ...p, visible: true }));
            productosVisibles = [...productosOriginales];
            renderTabla();
            cargarMarcasBajoStock();
        }

        function aplicarFiltros() {
            const marcaSeleccionada = document.getElementById('filtroMarcaBajoStock').value;
            const stockSeleccionado = document.getElementById('filtroStock').value;

            productosVisibles = productosOriginales.map(p => {
                let visible = true;

                if (marcaSeleccionada && p.marca_nombre !== marcaSeleccionada) visible = false;
                if (stockSeleccionado && String(p.stock) !== stockSeleccionado) visible = false;

                return { ...p, visible };
            });

            renderTabla();
        }

        function renderTabla() {
            const cont = document.getElementById('contenedor-bajo-stock');
            const visibles = productosVisibles.filter(p => p.visible);

            if (visibles.length === 0) {
                cont.innerHTML = '<p style="color:#b71c1c;">No hay productos visibles.</p>';
                return;
            }

            // Agrupar por categoría y por stock
            const categorias = {};
            visibles.forEach(p => {
                const cat = p.categoria_nombre || 'Sin categoría';
                if (!categorias[cat]) categorias[cat] = { '2': [], '1': [], '0': [] };
                if (p.stock === 2) categorias[cat]['2'].push(p);
                else if (p.stock === 1) categorias[cat]['1'].push(p);
                else categorias[cat]['0'].push(p);
            });

            let html = '';
            Object.keys(categorias).sort().forEach(cat => {
                html += `<div class="categoria-titulo">${cat}</div>`;
                ['2','1','0'].forEach(nivel => {
                    if (categorias[cat][nivel].length > 0) {
                        html += `<div class="stock-titulo" style="color:${nivel==='0'?'#d32f2f':nivel==='1'?'#f57c00':'#fbc02d'};">Stock = ${nivel}:</div>`;
                        html += `<table>
                            <thead>
                                <tr>
                                    <th>EAN</th>
                                    <th>Nombre</th>
                                    <th>Marca</th>
                                    <th>Stock</th>
                                    <th>Precio venta</th>
                                    <th>Gramos</th>
                                    <th>Ocultar</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${categorias[cat][nivel].map((p, idx) => `
                                    <tr class="stock-${nivel}">
                                        <td>${p.ean}</td>
                                        <td>${p.nombre}</td>
                                        <td>${p.marca_nombre || ''}</td>
                                        <td>${p.stock}</td>
                                        <td>${p.precio_venta ?? ''}</td>
                                        <td>${p.gramos ?? ''}</td>
                                        <td><button class="ocultar-btn" data-idx="${productosVisibles.indexOf(p)}">Ocultar</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`;
                    }
                });
            });
            cont.innerHTML = html;

            // Botones ocultar
            cont.querySelectorAll('.ocultar-btn').forEach(btn => {
                btn.onclick = function() {
                    const idx = parseInt(this.dataset.idx);
                    productosVisibles[idx].visible = false;
                    renderTabla();
                };
            });
        }

        document.getElementById('btn-mostrar-todos').onclick = function() {
            productosVisibles.forEach(p => p.visible = true);
            renderTabla();
        };

        document.getElementById('btn-exportar-pdf').onclick = function() {
            const visibles = productosVisibles.filter(p => p.visible);
            if (visibles.length === 0) {
                alert('No hay productos visibles para exportar.');
                return;
            }
            const categorias = {};
            visibles.forEach(p => {
                const cat = p.categoria_nombre || 'Sin categoría';
                if (!categorias[cat]) categorias[cat] = { '2': [], '1': [], '0': [] };
                if (p.stock === 2) categorias[cat]['2'].push(p);
                else if (p.stock === 1) categorias[cat]['1'].push(p);
                else categorias[cat]['0'].push(p);
            });

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            pdf.setFontSize(14);
            pdf.text('Productos con Bajo Stock (visibles)', 10, 10);

            let y = 18;
            pdf.setFontSize(10);

            Object.keys(categorias).sort().forEach(cat => {
                pdf.setFont(undefined, 'bold');
                pdf.text(cat, 10, y);
                y += 6;
                pdf.setFont(undefined, 'normal');
                ['2','1','0'].forEach(nivel => {
                    if (categorias[cat][nivel].length > 0) {
                        pdf.setTextColor(nivel==='0'?211: nivel==='1'?245:251, nivel==='0'?47: nivel==='1'?124:192, nivel==='0'?47: nivel==='1'?0:45);
                        pdf.text(`Stock = ${nivel}`, 12, y);
                        y += 6;
                        pdf.setTextColor(0,0,0);
                        categorias[cat][nivel].forEach(p => {
                            const texto = `${p.ean} - ${p.nombre} (${p.marca_nombre || ''}) | Stock: ${p.stock} | $${p.precio_venta ?? ''} | ${p.gramos ?? ''}g`;
                            pdf.text(texto, 16, y);
                            y += 6;
                            if (y > 280) { pdf.addPage(); y = 18; }
                        });
                        y += 2;
                    }
                });
                y += 2;
            });

            pdf.save('bajo_stock_visibles.pdf');
        };

        async function cargarMarcasBajoStock() {
            try {
                const res = await fetch('/marcas');
                let marcas = await res.json();
                marcas.sort((a, b) => a.nombre.localeCompare(b.nombre));
                const select = document.getElementById('filtroMarcaBajoStock');
                select.innerHTML = '<option value="">-- Todas las marcas --</option>';
                marcas.forEach(marca => {
                    const option = document.createElement('option');
                    option.value = marca.nombre;
                    option.textContent = marca.nombre;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Error al cargar marcas:', e);
            }
        }

        // Filtros activos
        document.getElementById('filtroMarcaBajoStock').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroStock').addEventListener('change', aplicarFiltros);

        cargarProductosBajoStock();
    </script>
</body>
</html>
