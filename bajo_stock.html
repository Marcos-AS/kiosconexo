<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Productos con Bajo Stock</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .categoria-titulo { font-weight: bold; color: #2a5d9f; margin-top: 1.5em; }
        .stock-titulo { font-weight: bold; margin-top: 1em; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #f5f5f5; }
        .ocultar-btn { font-size: 12px; margin-left: 8px; }
        .mostrar-btn { font-size: 12px; margin-bottom: 10px; }
        .stock-2 { background: #fffde7; }
        .stock-1 { background: #fff3e0; }
        .stock-0 { background: #ffebee; }
        .filtros { margin-bottom: 1em; }
    </style>
</head>
<body>
    <h1>Productos con Bajo Stock</h1>

    <div class="filtros">
        <label for="filtroMarcaBajoStock">
            Filtrar por marca:
            <select id="filtroMarcaBajoStock">
                <option value="">-- Todas las marcas --</option>
            </select>
        </label>

        <label for="filtroStock" style="margin-left: 1em;">
            Filtrar por stock:
            <select id="filtroStock">
                <option value="">-- Todos --</option>
                <option value="2">2</option>
                <option value="1">1</option>
                <option value="0">0</option>
            </select>
        </label>

        <button id="btn-exportar-pdf">Exportar visibles a PDF</button>
        <button id="btn-mostrar-todos" class="mostrar-btn">Mostrar todos</button>
    </div>

    <div id="contenedor-bajo-stock"></div>

    <script>
        let productosVisibles = [];
        let productosOriginales = [];

        async function cargarProductosBajoStock() {
            const res = await fetch('/productos-bajo-stock');
            let productos = await res.json();

            // Obtener últimos precios de compra
            const resCompras = await fetch('/compras/ultimas');
            const ultimasCompras = await resCompras.json();

            // Agregar info al producto
            productos.forEach(p => {
                const ultima = ultimasCompras.find(u => u.producto_ean === p.ean);
                if (ultima) {
                    p.ultimo_precio_compra = ultima.precio_compra;
                    p.ultimo_proveedor = ultima.proveedor_nombre;
                } else {
                    p.ultimo_precio_compra = null;
                    p.ultimo_proveedor = null;
                }
            });

            productosOriginales = productos.map(p => ({ ...p, visible: true }));
            productosVisibles = [...productosOriginales];
            renderTabla();
            cargarMarcasBajoStock();
        }


        function aplicarFiltros() {
            const marcaSeleccionada = document.getElementById('filtroMarcaBajoStock').value;
            const stockSeleccionado = document.getElementById('filtroStock').value;

            productosVisibles = productosOriginales.map(p => {
                let visible = true;

                if (marcaSeleccionada && p.marca_nombre !== marcaSeleccionada) visible = false;
                if (stockSeleccionado && String(p.stock) !== stockSeleccionado) visible = false;

                return { ...p, visible };
            });

            renderTabla();
        }

        function renderTabla() {
            const cont = document.getElementById('contenedor-bajo-stock');
            const visibles = productosVisibles.filter(p => p.visible);

            if (visibles.length === 0) {
                cont.innerHTML = '<p style="color:#b71c1c;">No hay productos visibles.</p>';
                return;
            }

            // Agrupar por categoría y por stock
            const categorias = {};
            visibles.forEach(p => {
                const cat = p.categoria_nombre || 'Sin categoría';
                if (!categorias[cat]) categorias[cat] = { '2': [], '1': [], '0': [] };
                if (p.stock === 2) categorias[cat]['2'].push(p);
                else if (p.stock === 1) categorias[cat]['1'].push(p);
                else categorias[cat]['0'].push(p);
            });

            let html = '';
            Object.keys(categorias).sort().forEach(cat => {
                html += `<div class="categoria-titulo">${cat}</div>`;
                ['2','1','0'].forEach(nivel => {
                    if (categorias[cat][nivel].length > 0) {
                        html += `<div class="stock-titulo" style="color:${nivel==='0'?'#d32f2f':nivel==='1'?'#f57c00':'#fbc02d'};">Stock = ${nivel}:</div>`;
                        html += `<table>
                            <thead>
                                <tr>
                                    <th>EAN</th>
                                    <th>Nombre</th>
                                    <th>Marca</th>
                                    <th>Stock</th>
                                    <th>Precio venta</th>
                                    <th>Gramos</th>
                                    <th>Ocultar</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${categorias[cat][nivel].map((p, idx) => `
                                    <tr class="stock-${nivel}">
                                        <td>${p.ean}</td>
                                        <td>${p.nombre}</td>
                                        <td>${p.marca_nombre || ''}</td>
                                        <td>${p.stock}</td>
                                        <td>${p.precio_venta ?? ''}</td>
                                        <td>${p.gramos ?? ''}</td>
                                        <td><button class="ocultar-btn" data-idx="${productosVisibles.indexOf(p)}">Ocultar</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>`;
                    }
                });
            });
            cont.innerHTML = html;

            // Botones ocultar
            cont.querySelectorAll('.ocultar-btn').forEach(btn => {
                btn.onclick = function() {
                    const idx = parseInt(this.dataset.idx);
                    productosVisibles[idx].visible = false;
                    renderTabla();
                };
            });
        }

        document.getElementById('btn-mostrar-todos').onclick = function() {
            productosVisibles.forEach(p => p.visible = true);
            renderTabla();
        };

document.getElementById('btn-exportar-pdf').onclick = function() {
    const visibles = productosVisibles.filter(p => p.visible);
    if (visibles.length === 0) {
        alert('No hay productos visibles para exportar.');
        return;
    }

    // Agrupar por categoría y stock
    const categorias = {};
    visibles.forEach(p => {
        const cat = p.categoria_nombre || 'Sin categoría';
        if (!categorias[cat]) categorias[cat] = { '2': [], '1': [], '0': [] };
        if (p.stock === 2) categorias[cat]['2'].push(p);
        else if (p.stock === 1) categorias[cat]['1'].push(p);
        else categorias[cat]['0'].push(p);
    });

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

    const margenX = 10;
    const margenY = 10;
    const anchoCol = 95; // mitad de la hoja A4 menos margen
    const altoPagina = 280;

    pdf.setFontSize(14);
    pdf.text('Productos con Bajo Stock (visibles)', margenX, margenY);
    pdf.setFontSize(10);

    let x = margenX;
    let y = margenY + 10;

    // función auxiliar para cambiar color por nivel de stock
    function setColorPorStock(nivel) {
        if (nivel === '0') pdf.setTextColor(211, 47, 47);     // rojo
        else if (nivel === '1') pdf.setTextColor(245, 124, 0); // naranja
        else pdf.setTextColor(251, 192, 45);                   // amarillo
    }

    Object.keys(categorias).sort().forEach(cat => {
        pdf.setFont(undefined, 'bold');
        pdf.setTextColor(42, 93, 159);
        pdf.text(cat, margenX, y);
        pdf.setFont(undefined, 'normal');
        pdf.setTextColor(0, 0, 0);
        y += 6;

        ['2', '1', '0'].forEach(nivel => {
            const lista = categorias[cat][nivel];
            if (lista.length === 0) return;

            setColorPorStock(nivel);
            pdf.setFont(undefined, 'bold');
            pdf.text(`Stock = ${nivel}`, x, y);
            pdf.setTextColor(0, 0, 0);
            pdf.setFont(undefined, 'normal');
            y += 5;

            // Recorremos de a pares (2 columnas)
            for (let i = 0; i < lista.length; i += 2) {
                const col1 = lista[i];
                const col2 = lista[i + 1];

                // Dibujar primera columna
                let yInicio = y;

                pdf.setFont(undefined, 'bold');
                const nombre1 = pdf.splitTextToSize(`${col1.nombre} (${col1.marca_nombre || ''})`, anchoCol - 20);
                pdf.text(nombre1, x, y);
                y += nombre1.length * 4;

                pdf.setFont(undefined, 'normal');
                const detalles1 = [
                    `Stock: ${col1.stock} | ${col1.gramos ?? ''}g`,
                    `Últ. compra: $${col1.ultimo_precio_compra ?? 'N/D'} - ${col1.ultimo_proveedor ?? 'N/D'}`,
                    `Precio venta: $${col1.precio_venta ?? 'N/D'}`
                ];
                detalles1.forEach(line => { pdf.text(line, x + 4, y); y += 4; });

                // Segunda columna (si existe)
                if (col2) {
                    let y2 = yInicio;
                    let x2 = margenX + anchoCol;

                    pdf.setFont(undefined, 'bold');
                    const nombre2 = pdf.splitTextToSize(`${col2.nombre} (${col2.marca_nombre || ''})`, anchoCol - 20);
                    pdf.text(nombre2, x2, y2);
                    y2 += nombre2.length * 4;

                    pdf.setFont(undefined, 'normal');
                    const detalles2 = [
                        `Stock: ${col2.stock} | ${col2.gramos ?? ''}g`,
                        `Últ. compra: $${col2.ultimo_precio_compra ?? 'N/D'} - ${col2.ultimo_proveedor ?? 'N/D'}`,
                        `Precio venta: $${col2.precio_venta ?? 'N/D'}`
                    ];
                    detalles2.forEach(line => { pdf.text(line, x2 + 4, y2); y2 += 4; });

                    // Calcular cuál columna fue más larga
                    y = Math.max(y, y2);
                }

                y += 6; // espacio entre filas de productos

                // Control de salto de página
                if (y > altoPagina) {
                    pdf.addPage();
                    x = margenX;
                    y = margenY + 10;
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(42, 93, 159);
                    pdf.text(cat + ' (cont.)', x, y);
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont(undefined, 'normal');
                    y += 8;
                }
            }

            y += 6; // espacio entre niveles de stock
        });

        y += 8; // espacio entre categorías
        if (y > altoPagina - 20) {
            pdf.addPage();
            x = margenX;
            y = margenY + 10;
        }
    });

    pdf.save('bajo_stock_visibles.pdf');
};





        async function cargarMarcasBajoStock() {
            try {
                const res = await fetch('/marcas');
                let marcas = await res.json();
                marcas.sort((a, b) => a.nombre.localeCompare(b.nombre));
                const select = document.getElementById('filtroMarcaBajoStock');
                select.innerHTML = '<option value="">-- Todas las marcas --</option>';
                marcas.forEach(marca => {
                    const option = document.createElement('option');
                    option.value = marca.nombre;
                    option.textContent = marca.nombre;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Error al cargar marcas:', e);
            }
        }

        // Filtros activos
        document.getElementById('filtroMarcaBajoStock').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroStock').addEventListener('change', aplicarFiltros);

        cargarProductosBajoStock();
    </script>
</body>
</html>
