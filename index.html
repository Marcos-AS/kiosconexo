<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MenÃº</title>
    <link rel="stylesheet" href="styles-index.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <a href="compras.html">Registrar compra a proveedor y ver compras hechas</a><br>
    <a href="lista-compras.html">Lista de compras (para ir a comprar al proveedor)</a><br>
    <a href="decomisacion.html">Decomisaciones</a>
    <br>
    <a href="historial_compras.html">Historial de compras por producto</a><br>
    <a href="agregar_promocion_combinada.html">Agregar promociÃ³n</a><br>
    <a href="ver_promociones_combinadas.html">Ver promociones</a>
    <a href="top-productos.html">Productos que mÃ¡s se vendieron</a><br>
    <a href="ventas-qr-mes.html">Para facturar</a><br>
    <a href="compras-mes.html">Compras facturadas</a><br>
    <a href="productos-precios.html">Margen productos</a><br>
    <a href="kpi.html">KPIs</a>
    <a href="analisis-compras.html">AnÃ¡lisis de las compras</a>
    <br><a href="bajo_stock.html">Productos con bajo stock</a>
    <br><a href="stock-secciones.html">Stock por secciones</a>

    <form action="" id="ingresar">
    <label for="ean">EAN</label>
    <input type="text" id="ean" autofocus>

    <label for="nombre">Nombre</label>
    <input type="text" id="nombre" >

    <label for="stock">Stock</label>
    <input type="number" id="stock" min="0">

    <label for="gramos">Gramos (opcional)</label>
    <input type="number" name="" id="gramos" step="any">
    <input type="checkbox" id="fijarGramos" title="Mantener estos gramos para el prÃ³ximo ingreso"> Fijar gramos

    <label for="categoria">Categoria</label>
    <input type="text" id="categoria" list="listaCategorias">
    <datalist id="listaCategorias"></datalist>
    <input type="checkbox" id="fijarCategoria" title="Mantener esta categorÃ­a para el prÃ³ximo ingreso"> Fijar categorÃ­a
    
    <label for="descripcion">DescripciÃ³n (opcional)</label>
    <input type="text" id="descripcion">
    
    <label for="marca">Marca</label>
    <input type="text" name="" id="marca">
    <datalist id="listaMarcas"></datalist>
    <input type="checkbox" id="fijarMarca" title="Mantener esta marca para el prÃ³ximo ingreso"> Fijar marca
    <button form="ingresar" class="btn-ingresar">Ingresar</button>
    </form>

    <a href="ventas.html">Registrar Venta</a>
    <hr><br>
    <a href="ganancias.html">Ver Ganancias por Lote</a>
    <br>
    <button id="btn-informe-compras">Exportar informe de compras a PDF</button>
    
    <h1>Inventario</h1>

    <label for="buscarEan">Buscar por EAN:</label>
    <input type="text" id="buscarEan" placeholder="Ingrese EAN">
    <button id="btnBuscarEan">Buscar</button>
    <button id="btnLimpiarEan">Limpiar BÃºsqueda</button>

    <label for="buscarNombre">Buscar por Nombre:</label>
    <input type="text" id="buscarNombre" placeholder="Ingrese Nombre del Producto">
    <button id="btnBuscarNombre">Buscar</button>
    <button id="btnLimpiarNombre">Limpiar BÃºsqueda</button>

    <label for="filtroCategoria">Filtrar por categorÃ­a</label>
    <select id="filtroCategoria"></select>

    <label for="filtroProveedor">Filtrar por proveedor</label>
    <select name="" id="filtroProveedor">
        <option value="">-- Mostrar todos --</option>
    </select>

    <label for="filtroMarca">Filtrar por marca</label>
    <select id="filtroMarca">
        <option value="">-- Mostrar todos --</option>
    </select>

    <label>
    <input type="checkbox" id="filtroStock"> Mostrar solo productos con stock
    </label>

    <label for="filtroPrecioVenta">
        <select id="filtroPrecioVenta">
            <option value="">-- Todos --</option>
            <option value="con">Con precio de venta</option>
            <option value="sin">Sin precio de venta</option>
        </select>
        Filtrar por precio de venta
    </label>



    <table border="1">
        <thead>
            <tr>
                <th class="ean-col">EAN</th>
                <th class="nombre-col">Nombre</th>
                <th class="stock-col">Stock</th>
                <th class="precio-venta-col">Precio de venta</th>
                <th class="gramos-col">Gramos</th>
                <th class="marca-col">Marca</th>
                <th class="categoria-col">CategorÃ­a</th>
            </tr>
        </thead>
        <tbody id="lista-productos">

        </tbody>
    </table>

    <script>
        const inputMarca = document.getElementById('marca');
        const datalist = document.getElementById('listaMarcas');
        const botonAgregar = document.getElementById('agregarBtn');

        inputMarca.addEventListener('input', async () => {
            const texto = inputMarca.value;

            if (texto.length < 1) {
                datalist.innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`/buscar-marcas?q=${encodeURIComponent(texto)}`);
                const marcas = await res.json();

                datalist.innerHTML = ''; // Limpiar sugerencias

                marcas.forEach(marca => {
                    const option = document.createElement('option');
                    option.value = marca;
                    datalist.appendChild(option);
                });
            } catch (err) {
                console.error('Error al buscar marcas:', err);
            }
        });

    const form = document.getElementById('ingresar');
    const lista = document.getElementById('lista-productos');
    const fijarCategoriaCheckbox = document.getElementById('fijarCategoria');
    const fijarMarcaCheckbox = document.getElementById('fijarMarca');
    const fijarGramosCheckbox = document.getElementById('fijarGramos');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            ean: document.getElementById('ean').value.trim(),
            nombre: document.getElementById('nombre').value.trim(),
            stock: parseInt(document.getElementById('stock').value) || 0,
            gramos: document.getElementById('gramos').value.trim(),
            descripcion: document.getElementById('descripcion').value.trim(),
            marca: document.getElementById('marca').value.trim(),
            categoria: document.getElementById('categoria').value.trim()
        };

        try {
            const res = await fetch('/productos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const mensaje = await res.text();
            alert(mensaje);

            if (res.ok) {
                await cargarProductos();
                cargarCategoriasSelect();
                cargarMarcasFiltro();

                const categoriaFija = fijarCategoriaCheckbox.checked;
                const marcaFija = fijarMarcaCheckbox.checked;
                const gramosFijo = fijarGramosCheckbox.checked;

                const categoriaValue = categoriaFija ? data.categoria : '';
                const marcaValue = marcaFija ? data.marca : '';
                const gramosValue = gramosFijo ? data.gramos : '';

                form.reset();

                document.getElementById('categoria').value = categoriaValue;
                document.getElementById('marca').value = marcaValue;
                document.getElementById('gramos').value = gramosValue;

                fijarCategoriaCheckbox.checked = categoriaFija;
                fijarMarcaCheckbox.checked = marcaFija;
                fijarGramosCheckbox.checked = gramosFijo;

                document.getElementById('ean').focus();
            }
        } catch (err) {
            console.error('Error al enviar producto:', err);
            alert('Error al enviar producto');
        }
    });

    async function cargarCategorias() {
        try {
        const res = await fetch('/categorias');
        const data = await res.json();

        const lista = document.getElementById('listaCategorias');
        lista.innerHTML = '';
        data.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.nombre;
            lista.appendChild(option);
        });
        } catch (e) {
        console.error('Error al cargar categorÃ­as:', e);
        }
    }

    
    let filtroStockActivo = false;

document.getElementById('filtroStock').addEventListener('change', function() {
    filtroStockActivo = this.checked;
    filtrarProductos();
});

async function filtrarProductos() {
    const categoriaId = document.getElementById('filtroCategoria').value;
    const proveedorId = document.getElementById('filtroProveedor').value;
    const marcaId = document.getElementById('filtroMarca').value;
    const eanBuscado = document.getElementById('buscarEan').value.trim();
    const nombreBuscado = inputBuscarNombre.value.trim();
    const filtroPrecioVenta = document.getElementById('filtroPrecioVenta').value;

    let url = '/productos';
    const params = new URLSearchParams();

    if (categoriaId) params.append('categoriaId', categoriaId);
    if (proveedorId) params.append('proveedorId', proveedorId);
    if (marcaId) params.append('marcaId', marcaId);
    if (eanBuscado) params.append('ean', eanBuscado);
    if (nombreBuscado) params.append('nombre', nombreBuscado);

    if (params.toString()) url += `?${params.toString()}`;

    const res = await fetch(url);
    let data = await res.json();

    // Aplica el filtro de stock aquÃ­, combinando con los demÃ¡s
    if (filtroStockActivo) {
        data = data.filter(prod => prod.stock > 0);
    }

    // Aplica el filtro de precio de venta
    if (filtroPrecioVenta === 'con') {
        data = data.filter(prod => prod.precio_venta !== null && prod.precio_venta !== undefined && prod.precio_venta !== '');
    } else if (filtroPrecioVenta === 'sin') {
        data = data.filter(prod => prod.precio_venta === null || prod.precio_venta === undefined || prod.precio_venta === '');
    }

    // Ordena por stock descendente (mayor stock arriba)
    data.sort((a, b) => (a.stock ?? 0) - (b.stock ?? 0));

    mostrarProductos(data);
}

    async function cargarProductos() {
    try {
        const res = await fetch('/productos');
        let productos = await res.json();

        //Elimina este bloque, ya no filtra por stock aquÃ­
        if (filtroStockActivo) {
            productos = productos.filter(prod => prod.stock > 0);
        }


        mostrarProductos(productos);
    } catch (e) {
        console.error('Error al cargar productos:', e);
    }
}


    function cargarCategoriasSelect() {
        fetch('/categorias')
            .then(res => res.json())
            .then(data => {
                // Ordenar alfabÃ©ticamente por nombre
                data.sort((a, b) => a.nombre.localeCompare(b.nombre));
                const select = document.getElementById('filtroCategoria');
                select.innerHTML = '<option value="">-- Mostrar todos --</option>';
                data.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nombre;
                    select.appendChild(option);
                });
            });
    }

    async function cargarMarcasFiltro() {
        try {
            const res = await fetch('/marcas');
            const data = await res.json();
            // Ordenar alfabÃ©ticamente por nombre
            data.sort((a, b) => a.nombre.localeCompare(b.nombre));
            const select = document.getElementById('filtroMarca');
            select.innerHTML = '<option value="">-- Mostrar todos --</option>';
            data.forEach(marca => {
                const option = document.createElement('option');
                option.value = marca.id;
                option.textContent = marca.nombre;
                select.appendChild(option);
            });
        } catch (e) {
            console.error('Error al cargar marcas para el filtro:', e);
        }
    }

    // Mostrar productos en la tabla (funciÃ³n reutilizable)
function mostrarProductos(productos) {
    const tbody = document.getElementById('lista-productos');
    tbody.innerHTML = '';

    productos.forEach(prod => {
        const tr = document.createElement('tr');

        // Sanitizar valores nulos o undefined
        const stockVal = prod.stock != null && !isNaN(prod.stock) ? prod.stock : '';
        const precioVentaVal = prod.precio_venta != null && !isNaN(prod.precio_venta) ? prod.precio_venta : '';
        const gramosVal = prod.gramos != null && !isNaN(prod.gramos) ? prod.gramos : '';
        const marcaVal = prod.marca_nombre || '';
        const categoriaVal = prod.categoria_nombre || '';

        tr.innerHTML = `
            <td class="ean-col">
                ${prod.ean}
                <button onclick="pegarEAN('${prod.ean}')">ðŸ“‹</button>
            </td>
            <td class="nombre-col">
                <input type="text" value="${prod.nombre || ''}" data-ean="${prod.ean}" class="nombre-edit" style="width: 98%; min-width: 120px">
                <button onclick="guardarNombre(this)">ðŸ’¾</button>
            </td>
            <td class="stock-col">
                <input type="number" min="0" value="${stockVal}" data-ean="${prod.ean}" />
                <button onclick="actualizarStock(this)">ðŸ’¾</button>
            </td>
            <td class="precio-venta-col">
                <input type="number" min="0" step="0.01" value="${precioVentaVal}" data-ean="${prod.ean}" class="input-precio-venta">
                <button onclick="guardarPrecioVenta(this)">ðŸ’¾</button>
            </td>
            <td class="gramos-col">
                <input type="number" step="any" data-ean="${prod.ean}" value="${gramosVal}" />
                <button onclick="guardarGramos(this)">ðŸ’¾</button>
            </td>
            <td class="marca-col">
                <input type="text" value="${marcaVal}" data-ean="${prod.ean}" class="marca-edit" style="width: 90%">
                <button onclick="guardarMarca(this)">ðŸ’¾</button>
            </td>
            <td class="categoria-col">
                <input type="text" value="${categoriaVal}" data-ean="${prod.ean}" class="categoria-edit" style="width: 90%" list="listaCategorias">
                <button onclick="guardarCategoria(this)">ðŸ’¾</button>
            </td>
        `;

        tbody.appendChild(tr);
    });
}



async function cargarProveedoresFiltro() {
    try {
        const res = await fetch('/proveedores');
        const data = await res.json();
        const select = document.getElementById('filtroProveedor');
        select.innerHTML = '<option value="">-- Mostrar todos --</option>';
        data.forEach(prov => {
            const option = document.createElement('option');
            option.value = prov.id;
            option.textContent = prov.nombre;
            select.appendChild(option);
        });
    } catch (e) {
        console.error('Error al cargar proveedores (filtro):', e);
    }
}

function pegarEAN(ean) {
    const input = document.getElementById('productoPrecio');
    input.value = ean;
    input.focus();
    input.select(); // Opcional: selecciona el texto para que se sobrescriba fÃ¡cil
}

function borrarPrecio() {
    document.getElementById('precio').value = '';
    document.getElementById('precio').focus();
}

async function guardarNombre(button) {
    const input = button.previousElementSibling;
    const nuevoNombre = input.value.trim();
    const ean = input.dataset.ean;

    if (!nuevoNombre) {
        alert('El nombre no puede estar vacÃ­o.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/nombre`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nombre: nuevoNombre })
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
            await filtrarProductos(); // refrescar tabla
        }
    } catch (err) {
        console.error('Error al actualizar el nombre:', err);
        alert('Error al actualizar el nombre');
    }
}


async function guardarMarca(button) {
    const input = button.previousElementSibling;
    const nuevaMarca = input.value.trim();
    const ean = input.dataset.ean;

    if (!nuevaMarca) {
        alert('La marca no puede estar vacÃ­a.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/marca`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nombreMarca: nuevaMarca })
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
            await filtrarProductos(); // Refresca la tabla si hay filtros aplicados
        }
    } catch (err) {
        console.error('Error al actualizar la marca:', err);
        alert('Error al actualizar la marca');
    }
}

async function guardarCategoria(button) {
    const input = button.previousElementSibling;
    const nuevaCategoria = input.value.trim();
    const ean = input.dataset.ean;

    if (!nuevaCategoria) {
        alert('La categorÃ­a no puede estar vacÃ­a.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/categoria`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombreCategoria: nuevaCategoria })
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
            await filtrarProductos();
        }
    } catch (err) {
        console.error('Error al actualizar la categorÃ­a:', err);
        alert('Error al actualizar la categorÃ­a');
    }
}

async function guardarGramos(button) {
    const input = button.previousElementSibling;
    const gramos = parseFloat(input.value);
    const ean = input.dataset.ean;

    if (isNaN(gramos)) {
        alert('Los gramos deben ser un nÃºmero vÃ¡lido.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/gramos`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ gramos })
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
            await filtrarProductos(); // o recargarTablaProductos();
        }
    } catch (err) {
        console.error('Error al actualizar los gramos:', err);
        alert('Error al actualizar los gramos');
    }
}

async function guardarPrecioVenta(button) {
    const td = button.parentElement;
    const input = td.querySelector('.input-precio-venta');
    const precioVenta = parseFloat(input.value.trim());
    const ean = input.dataset.ean;

    if (isNaN(precioVenta) || precioVenta < 0) {
        alert('Ingrese un precio de venta vÃ¡lido.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/precio-venta`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ precio_venta: precioVenta })
        });
        const msg = await res.text();
        alert(msg);
    } catch (err) {
        alert('Error al guardar el precio de venta');
    }
}

const inputBuscarNombre = document.getElementById('buscarNombre');
const btnBuscarNombre = document.getElementById('btnBuscarNombre');
const btnLimpiarNombre = document.getElementById('btnLimpiarNombre');


async function actualizarStock(boton) {
    const input = boton.previousElementSibling;
    const stock = input.value;
    const ean = input.dataset.ean;

    try {
        const res = await fetch(`/productos/${ean}/stock`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ stock: parseInt(stock) })
        });

        const result = await res.json();
        alert(result.mensaje);
    } catch (error) {
        console.error('Error al actualizar stock:', error);
        alert('Error al actualizar stock');
    }
}


document.getElementById('filtroCategoria').addEventListener('change', filtrarProductos);
document.getElementById('filtroProveedor').addEventListener('change', filtrarProductos);
document.getElementById('filtroMarca').addEventListener('change', filtrarProductos);

document.getElementById('btnBuscarEan').addEventListener('click', filtrarProductos);
document.getElementById('btnLimpiarEan').addEventListener('click', () => {
    document.getElementById('buscarEan').value = ''; // Limpiar el campo
    filtrarProductos(); // Volver a cargar los productos sin el filtro de EAN
});
// TambiÃ©n puedes querer que al presionar enter en el campo EAN se busque
document.getElementById('buscarEan').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault(); // Evita que el formulario se envÃ­e
        filtrarProductos();
    }
});

btnBuscarNombre.addEventListener('click', filtrarProductos);

btnLimpiarNombre.addEventListener('click', () => {
    inputBuscarNombre.value = ''; // Limpiar el campo
    filtrarProductos(); // Volver a cargar los productos sin el filtro de nombre
});

inputBuscarNombre.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault(); // Evita que el formulario se envÃ­e si el input estÃ¡ dentro de un form
        filtrarProductos();
    }
});

document.getElementById('filtroPrecioVenta').addEventListener('change', filtrarProductos);

document.getElementById('btn-informe-compras').onclick = async function() {
    const res = await fetch('/compras');
    const compras = await res.json();
    // Obtener productos con categorÃ­a
    const resProd = await fetch('/productos');
    const productos = await resProd.json();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Agrupa y toma solo la Ãºltima compra de cada producto+gramos
    const ultimasCompras = {};
    compras.forEach(compra => {
        const clave = `${compra.producto_nombre}||${compra.gramos}`;
        if (
            !ultimasCompras[clave] ||
            new Date(compra.fecha) > new Date(ultimasCompras[clave].fecha)
        ) {
            ultimasCompras[clave] = compra;
        }
    });

    // Une con la categorÃ­a
    Object.values(ultimasCompras).forEach(compra => {
        const prod = productos.find(p => 
            p.nombre === compra.producto_nombre && 
            String(p.gramos || '') === String(compra.gramos || '')
        );
        compra.categoria_nombre = prod ? prod.categoria_nombre : 'Sin categorÃ­a';
    });

    // Agrupa por categorÃ­a
    const comprasPorCategoria = {};
    Object.values(ultimasCompras).forEach(compra => {
        const cat = compra.categoria_nombre || 'Sin categorÃ­a';
        if (!comprasPorCategoria[cat]) comprasPorCategoria[cat] = [];
        comprasPorCategoria[cat].push(compra);
    });

    doc.setFontSize(9);
    doc.text('Informe de Compras (Ãºltima por producto, ordenado por categorÃ­a)', 10, 10);

    let y = 18;
    let col1x = 10;
    let col2x = 110;
    for (const categoria of Object.keys(comprasPorCategoria).sort()) {
        doc.setFont(undefined, 'bold');
        doc.text(`${categoria}:`, 10, y);
        doc.setFont(undefined, 'normal');
        y += 6;
        let col = 0;
        comprasPorCategoria[categoria].forEach(compra => {
            const texto = `${compra.producto_nombre} (${compra.gramos || ''}g) - $${compra.precio_compra}`;
            if (col === 0) {
                doc.text(texto, col1x, y);
                col = 1;
            } else {
                doc.text(texto, col2x, y);
                col = 0;
                y += 6;
            }
            if (y > 280) { doc.addPage(); y = 18; }
        });
        // Si hay una fila sola al final, salta la lÃ­nea
        if (col === 1) y += 6;
        y += 2; // Espacio extra entre categorÃ­as
    }

    doc.save('informe-compras.pdf');
};

async function eliminarProducto(ean) {
    if (!confirm('Â¿Seguro que desea eliminar este producto?')) return;
    try {
        const res = await fetch(`/productos/${ean}`, {
            method: 'DELETE'
        });
        const msg = await res.text();
        alert(msg);
        if (res.ok) {
            await cargarProductos();
            filtrarProductos();
        }
    } catch (err) {
        alert('Error al eliminar producto');
    }
}

document.getElementById('ingresar').addEventListener('keydown', function (e) {
    const esEnter = e.key === 'Enter';
    const esInput = e.target.tagName === 'INPUT';
    const esBotonSubmit = e.target.type === 'submit';

    // Si se presionÃ³ Enter en un input (no en el botÃ³n), cancelar el envÃ­o
    if (esEnter && esInput && !esBotonSubmit) {
        e.preventDefault();
    }
});

    async function cargarMarcasBajoStock() {
        try {
            const res = await fetch('/marcas');
            let marcas = await res.json();
            // Ordenar alfabÃ©ticamente por nombre
            marcas.sort((a, b) => a.nombre.localeCompare(b.nombre));
            const select = document.getElementById('filtroMarcaBajoStock');
            select.innerHTML = '<option value="">-- Todas las marcas --</option>';
            marcas.forEach(marca => {
                const option = document.createElement('option');
                option.value = marca.nombre;
                option.textContent = marca.nombre;
                select.appendChild(option);
            });
        } catch (e) {
            console.error('Error al cargar marcas para bajo stock:', e);
        }
    }

    cargarCategorias();
    cargarCategoriasSelect();
    cargarProveedoresFiltro();
    cargarMarcasFiltro();
    cargarProductos();
    </script>
</body>
</html>