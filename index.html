<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="styles-index.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <a href="compras.html">Registrar compra a proveedor y ver compras hechas</a><br>
    <a href="lista-compras.html">Lista de compras (para ir a comprar al proveedor)</a><br>
    <a href="decomisacion.html">Decomisaciones</a>
    <br>
    <a href="historial_compras.html">Historial de compras por producto</a><br>
    <a href="agregar_promocion_combinada.html">Promociones</a><br>
    <a href="top-productos.html">Productos que m√°s se vendieron</a><br>
    <a href="ventas-qr-mes.html">Para facturar</a><br>
    <a href="compras-mes.html">Compras facturadas</a><br>
    <a href="productos-precios.html">Margen productos</a><br>
    <a href="kpi.html">KPIs</a>

    <form action="" id="ingresar">
    <label for="ean">EAN</label>
    <input type="text" id="ean" autofocus>

    <label for="nombre">Nombre</label>
    <input type="text" id="nombre" >

    <label for="stock">Stock</label>
    <input type="number" id="stock" min="0">

    <label for="gramos">Gramos (opcional)</label>
    <input type="number" name="" id="gramos" step="any">
    <input type="checkbox" id="fijarGramos" title="Mantener estos gramos para el pr√≥ximo ingreso"> Fijar gramos

    <label for="categoria">Categoria</label>
    <input type="text" id="categoria" list="listaCategorias">
    <datalist id="listaCategorias"></datalist>
    <input type="checkbox" id="fijarCategoria" title="Mantener esta categor√≠a para el pr√≥ximo ingreso"> Fijar categor√≠a
    
    <label for="descripcion">Descripci√≥n (opcional)</label>
    <input type="text" id="descripcion">
    
    <label for="marca">Marca</label>
    <input type="text" name="" id="marca">
    <datalist id="listaMarcas"></datalist>
    <input type="checkbox" id="fijarMarca" title="Mantener esta marca para el pr√≥ximo ingreso"> Fijar marca
    <button form="ingresar" class="btn-ingresar">Ingresar</button>
    </form>

    <a href="ventas.html">Registrar Venta</a>
    <hr><br>
    <a href="ganancias.html">Ver Ganancias por Lote</a>
    <br>
    <button id="btn-informe-compras">Exportar informe de compras a PDF</button>
    
    <h1>Inventario</h1>

    <label for="buscarEan">Buscar por EAN:</label>
    <input type="text" id="buscarEan" placeholder="Ingrese EAN">
    <button id="btnBuscarEan">Buscar</button>
    <button id="btnLimpiarEan">Limpiar B√∫squeda</button>

    <label for="buscarNombre">Buscar por Nombre:</label>
    <input type="text" id="buscarNombre" placeholder="Ingrese Nombre del Producto">
    <button id="btnBuscarNombre">Buscar</button>
    <button id="btnLimpiarNombre">Limpiar B√∫squeda</button>

    <label for="filtroCategoria">Filtrar por categor√≠a</label>
    <select id="filtroCategoria"></select>

    <label for="filtroProveedor">Filtrar por proveedor</label>
    <select name="" id="filtroProveedor">
        <option value="">-- Mostrar todos --</option>
    </select>

    <label for="filtroMarca">Filtrar por marca</label>
    <select id="filtroMarca">
        <option value="">-- Mostrar todos --</option>
    </select>

    <label>
    <input type="checkbox" id="filtroStock"> Mostrar solo productos con stock
    </label>

    <label for="filtroPrecioVenta">
        <select id="filtroPrecioVenta">
            <option value="">-- Todos --</option>
            <option value="con">Con precio de venta</option>
            <option value="sin">Sin precio de venta</option>
        </select>
        Filtrar por precio de venta
    </label>

    <label for="filtroMarcaBajoStock">
    Filtrar bajo stock por marca:
    <select id="filtroMarcaBajoStock">
        <option value="">-- Todas las marcas --</option>
    </select>
    </label>
    <div id="alerta-bajo-stock"></div>
    <button id="btn-exportar-bajo-stock">Exportar bajo stock a PDF</button>


    <table border="1">
        <thead>
            <tr>
                <th class="ean-col">EAN</th>
                <th class="nombre-col">Nombre</th>
                <th class="stock-col">Stock</th>
                <th class="precio-venta-col">Precio de venta</th>
                <th class="gramos-col">Gramos</th>
                <th>Descripci√≥n</th>
                <th class="marca-col">Marca</th>
                <th class="categoria-col">Categor√≠a</th>
            </tr>
        </thead>
        <tbody id="lista-productos">

        </tbody>
    </table>

    <script>
        const inputMarca = document.getElementById('marca');
        const datalist = document.getElementById('listaMarcas');
        const botonAgregar = document.getElementById('agregarBtn');

        inputMarca.addEventListener('input', async () => {
            const texto = inputMarca.value;

            if (texto.length < 1) {
                datalist.innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`/buscar-marcas?q=${encodeURIComponent(texto)}`);
                const marcas = await res.json();

                datalist.innerHTML = ''; // Limpiar sugerencias

                marcas.forEach(marca => {
                    const option = document.createElement('option');
                    option.value = marca;
                    datalist.appendChild(option);
                });
            } catch (err) {
                console.error('Error al buscar marcas:', err);
            }
        });

    const form = document.getElementById('ingresar');
    const lista = document.getElementById('lista-productos');
    const fijarCategoriaCheckbox = document.getElementById('fijarCategoria');
    const fijarMarcaCheckbox = document.getElementById('fijarMarca');
    const fijarGramosCheckbox = document.getElementById('fijarGramos');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            ean: document.getElementById('ean').value.trim(),
            nombre: document.getElementById('nombre').value.trim(),
            stock: parseInt(document.getElementById('stock').value) || 0,
            gramos: document.getElementById('gramos').value.trim(),
            descripcion: document.getElementById('descripcion').value.trim(),
            marca: document.getElementById('marca').value.trim(),
            categoria: document.getElementById('categoria').value.trim()
        };

        try {
            const res = await fetch('/productos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const mensaje = await res.text();
            alert(mensaje);

            if (res.ok) {
                await cargarProductos();
                cargarCategoriasSelect();
                cargarMarcasFiltro();

                const categoriaFija = fijarCategoriaCheckbox.checked;
                const marcaFija = fijarMarcaCheckbox.checked;
                const gramosFijo = fijarGramosCheckbox.checked;

                const categoriaValue = categoriaFija ? data.categoria : '';
                const marcaValue = marcaFija ? data.marca : '';
                const gramosValue = gramosFijo ? data.gramos : '';

                form.reset();

                document.getElementById('categoria').value = categoriaValue;
                document.getElementById('marca').value = marcaValue;
                document.getElementById('gramos').value = gramosValue;

                fijarCategoriaCheckbox.checked = categoriaFija;
                fijarMarcaCheckbox.checked = marcaFija;
                fijarGramosCheckbox.checked = gramosFijo;

                document.getElementById('ean').focus();
            }
        } catch (err) {
            console.error('Error al enviar producto:', err);
            alert('Error al enviar producto');
        }
    });

    async function cargarCategorias() {
        try {
        const res = await fetch('/categorias');
        const data = await res.json();

        const lista = document.getElementById('listaCategorias');
        lista.innerHTML = '';
        data.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.nombre;
            lista.appendChild(option);
        });
        } catch (e) {
        console.error('Error al cargar categor√≠as:', e);
        }
    }

    
    let filtroStockActivo = false;

document.getElementById('filtroStock').addEventListener('change', function() {
    filtroStockActivo = this.checked;
    filtrarProductos();
});

async function filtrarProductos() {
    const categoriaId = document.getElementById('filtroCategoria').value;
    const proveedorId = document.getElementById('filtroProveedor').value;
    const marcaId = document.getElementById('filtroMarca').value;
    const eanBuscado = document.getElementById('buscarEan').value.trim();
    const nombreBuscado = inputBuscarNombre.value.trim();
    const filtroPrecioVenta = document.getElementById('filtroPrecioVenta').value;

    let url = '/productos';
    const params = new URLSearchParams();

    if (categoriaId) params.append('categoriaId', categoriaId);
    if (proveedorId) params.append('proveedorId', proveedorId);
    if (marcaId) params.append('marcaId', marcaId);
    if (eanBuscado) params.append('ean', eanBuscado);
    if (nombreBuscado) params.append('nombre', nombreBuscado);

    if (params.toString()) url += `?${params.toString()}`;

    const res = await fetch(url);
    let data = await res.json();

    // Aplica el filtro de stock aqu√≠, combinando con los dem√°s
    if (filtroStockActivo) {
        data = data.filter(prod => prod.stock > 0);
    }

    // Aplica el filtro de precio de venta
    if (filtroPrecioVenta === 'con') {
        data = data.filter(prod => prod.precio_venta !== null && prod.precio_venta !== undefined && prod.precio_venta !== '');
    } else if (filtroPrecioVenta === 'sin') {
        data = data.filter(prod => prod.precio_venta === null || prod.precio_venta === undefined || prod.precio_venta === '');
    }

    mostrarProductos(data);
}

    async function cargarProductos() {
    try {
        const res = await fetch('/productos');
        let productos = await res.json();

        // Elimina este bloque, ya no filtra por stock aqu√≠
        // if (filtroStockActivo) {
        //     productos = productos.filter(prod => prod.stock > 0);
        // }

        mostrarProductos(productos);
    } catch (e) {
        console.error('Error al cargar productos:', e);
    }
}


    function cargarCategoriasSelect() {
        fetch('/categorias')
            .then(res => res.json())
            .then(data => {
                // Ordenar alfab√©ticamente por nombre
                data.sort((a, b) => a.nombre.localeCompare(b.nombre));
                const select = document.getElementById('filtroCategoria');
                select.innerHTML = '<option value="">-- Mostrar todos --</option>';
                data.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nombre;
                    select.appendChild(option);
                });
            });
    }

    async function cargarMarcasFiltro() {
        try {
            const res = await fetch('/marcas');
            const data = await res.json();
            // Ordenar alfab√©ticamente por nombre
            data.sort((a, b) => a.nombre.localeCompare(b.nombre));
            const select = document.getElementById('filtroMarca');
            select.innerHTML = '<option value="">-- Mostrar todos --</option>';
            data.forEach(marca => {
                const option = document.createElement('option');
                option.value = marca.id;
                option.textContent = marca.nombre;
                select.appendChild(option);
            });
        } catch (e) {
            console.error('Error al cargar marcas para el filtro:', e);
        }
    }

    // Mostrar productos en la tabla (funci√≥n reutilizable)
function mostrarProductos(productos) {
    const tbody = document.getElementById('lista-productos');
    tbody.innerHTML = '';

        productos.forEach(prod => {
            const tr = document.createElement('tr');

            // Precio inicial (puede ser vac√≠o)
            let precioInicial = '';

            tr.innerHTML = `
                <td class="ean-col">
                    ${prod.ean}
                    <button onclick="pegarEAN('${prod.ean}')">üìã</button>
                </td>
                <td class="nombre-col">
                    <input type="text" value="${prod.nombre}" data-ean="${prod.ean}" class="nombre-edit" style="width: 98%; min-width: 120px">
                    <button onclick="guardarNombre(this)">üíæ</button>
                </td>
                <td class="stock-col">
                    <input type="number" min="0" value="${prod.stock != null ? prod.stock : ''}" data-ean="${prod.ean}" />
                    <button onclick="actualizarStock(this)">üíæ</button>
                </td>
                <td class="precio-venta-col">
                    <input type="number" min="0" step="0.01" value="${prod.precio_venta ?? ''}" data-ean="${prod.ean}" class="input-precio-venta">
                    <button onclick="guardarPrecioVenta(this)">üíæ</button>
                </td>
                <td class="gramos-col">
                    <input type="number" step="any" data-ean="${prod.ean}" value="${prod.gramos}" />
                    <button onclick="guardarGramos(this)">üíæ</button>
                </td>
                <td>${prod.descripcion || ''}</td>
                <td class="marca-col">
                    <input type="text" value="${prod.marca_nombre}" data-ean="${prod.ean}" class="marca-edit" style="width: 90%">
                    <button onclick="guardarMarca(this)">üíæ</button>
                </td>
                <td class="categoria-col">
                    <input type="text" value="${prod.categoria_nombre}" data-ean="${prod.ean}" class="categoria-edit" style="width: 90%" list="listaCategorias">
                    <button onclick="guardarCategoria(this)">üíæ</button>
                </td>
            `;
            //boton eliminar producto
                // <td>
                //     <button onclick="eliminarProducto('${prod.ean}')" style="color:red;">üóëÔ∏è Eliminar</button>
                // </td>

    
            tbody.appendChild(tr);
    });}

async function cargarProveedoresFiltro() {
    try {
        const res = await fetch('/proveedores');
        const data = await res.json();
        const select = document.getElementById('filtroProveedor');
        select.innerHTML = '<option value="">-- Mostrar todos --</option>';
        data.forEach(prov => {
            const option = document.createElement('option');
            option.value = prov.id;
            option.textContent = prov.nombre;
            select.appendChild(option);
        });
    } catch (e) {
        console.error('Error al cargar proveedores (filtro):', e);
    }
}

function pegarEAN(ean) {
    const input = document.getElementById('productoPrecio');
    input.value = ean;
    input.focus();
    input.select(); // Opcional: selecciona el texto para que se sobrescriba f√°cil
}

function borrarPrecio() {
    document.getElementById('precio').value = '';
    document.getElementById('precio').focus();
}

async function guardarNombre(button) {
    const input = button.previousElementSibling;
    const nuevoNombre = input.value.trim();
    const ean = input.dataset.ean;

    if (!nuevoNombre) {
        alert('El nombre no puede estar vac√≠o.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/nombre`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nombre: nuevoNombre })
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
            await filtrarProductos(); // refrescar tabla
        }
    } catch (err) {
        console.error('Error al actualizar el nombre:', err);
        alert('Error al actualizar el nombre');
    }
}


async function guardarMarca(button) {
    const input = button.previousElementSibling;
    const nuevaMarca = input.value.trim();
    const ean = input.dataset.ean;

    if (!nuevaMarca) {
        alert('La marca no puede estar vac√≠a.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/marca`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nombreMarca: nuevaMarca })
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
            await filtrarProductos(); // Refresca la tabla si hay filtros aplicados
        }
    } catch (err) {
        console.error('Error al actualizar la marca:', err);
        alert('Error al actualizar la marca');
    }
}

async function guardarCategoria(button) {
    const input = button.previousElementSibling;
    const nuevaCategoria = input.value.trim();
    const ean = input.dataset.ean;

    if (!nuevaCategoria) {
        alert('La categor√≠a no puede estar vac√≠a.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/categoria`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombreCategoria: nuevaCategoria })
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
            await filtrarProductos();
        }
    } catch (err) {
        console.error('Error al actualizar la categor√≠a:', err);
        alert('Error al actualizar la categor√≠a');
    }
}

async function guardarGramos(button) {
    const input = button.previousElementSibling;
    const gramos = parseFloat(input.value);
    const ean = input.dataset.ean;

    if (isNaN(gramos)) {
        alert('Los gramos deben ser un n√∫mero v√°lido.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/gramos`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ gramos })
        });

        const msg = await res.text();
        alert(msg);

        if (res.ok) {
            await filtrarProductos(); // o recargarTablaProductos();
        }
    } catch (err) {
        console.error('Error al actualizar los gramos:', err);
        alert('Error al actualizar los gramos');
    }
}

async function guardarPrecioVenta(button) {
    const td = button.parentElement;
    const input = td.querySelector('.input-precio-venta');
    const precioVenta = parseFloat(input.value.trim());
    const ean = input.dataset.ean;

    if (isNaN(precioVenta) || precioVenta < 0) {
        alert('Ingrese un precio de venta v√°lido.');
        return;
    }

    try {
        const res = await fetch(`/productos/${ean}/precio-venta`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ precio_venta: precioVenta })
        });
        const msg = await res.text();
        alert(msg);
    } catch (err) {
        alert('Error al guardar el precio de venta');
    }
}

const inputBuscarNombre = document.getElementById('buscarNombre');
const btnBuscarNombre = document.getElementById('btnBuscarNombre');
const btnLimpiarNombre = document.getElementById('btnLimpiarNombre');

async function filtrarProductos() {
    const categoriaId = document.getElementById('filtroCategoria').value;
    const proveedorId = document.getElementById('filtroProveedor').value;
    const marcaId = document.getElementById('filtroMarca').value;
    const eanBuscado = document.getElementById('buscarEan').value.trim();
    const nombreBuscado = inputBuscarNombre.value.trim();
    const filtroPrecioVenta = document.getElementById('filtroPrecioVenta').value;

    let url = '/productos';
    const params = new URLSearchParams();

    if (categoriaId) params.append('categoriaId', categoriaId);
    if (proveedorId) params.append('proveedorId', proveedorId);
    if (marcaId) params.append('marcaId', marcaId);
    if (eanBuscado) params.append('ean', eanBuscado);
    if (nombreBuscado) params.append('nombre', nombreBuscado);

    if (params.toString()) url += `?${params.toString()}`;

    const res = await fetch(url);
    let data = await res.json();

    // Aplica el filtro de stock aqu√≠, combinando con los dem√°s
    if (filtroStockActivo) {
        data = data.filter(prod => prod.stock > 0);
    }

    // Aplica el filtro de precio de venta
    if (filtroPrecioVenta === 'con') {
        data = data.filter(prod => prod.precio_venta !== null && prod.precio_venta !== undefined && prod.precio_venta !== '');
    } else if (filtroPrecioVenta === 'sin') {
        data = data.filter(prod => prod.precio_venta === null || prod.precio_venta === undefined || prod.precio_venta === '');
    }

    mostrarProductos(data);
}

async function actualizarStock(boton) {
    const input = boton.previousElementSibling;
    const stock = input.value;
    const ean = input.dataset.ean;

    try {
        const res = await fetch(`/productos/${ean}/stock`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ stock: parseInt(stock) })
        });

        const result = await res.json();
        alert(result.mensaje);
    } catch (error) {
        console.error('Error al actualizar stock:', error);
        alert('Error al actualizar stock');
    }
}


document.getElementById('filtroCategoria').addEventListener('change', filtrarProductos);
document.getElementById('filtroProveedor').addEventListener('change', filtrarProductos);
document.getElementById('filtroMarca').addEventListener('change', filtrarProductos);

document.getElementById('btnBuscarEan').addEventListener('click', filtrarProductos);
document.getElementById('btnLimpiarEan').addEventListener('click', () => {
    document.getElementById('buscarEan').value = ''; // Limpiar el campo
    filtrarProductos(); // Volver a cargar los productos sin el filtro de EAN
});
// Tambi√©n puedes querer que al presionar enter en el campo EAN se busque
document.getElementById('buscarEan').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault(); // Evita que el formulario se env√≠e
        filtrarProductos();
    }
});

btnBuscarNombre.addEventListener('click', filtrarProductos);

btnLimpiarNombre.addEventListener('click', () => {
    inputBuscarNombre.value = ''; // Limpiar el campo
    filtrarProductos(); // Volver a cargar los productos sin el filtro de nombre
});

inputBuscarNombre.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault(); // Evita que el formulario se env√≠e si el input est√° dentro de un form
        filtrarProductos();
    }
});

document.getElementById('filtroPrecioVenta').addEventListener('change', filtrarProductos);

document.getElementById('btn-informe-compras').onclick = async function() {
    const res = await fetch('/compras');
    const compras = await res.json();
    // Obtener productos con categor√≠a
    const resProd = await fetch('/productos');
    const productos = await resProd.json();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Agrupa y toma solo la √∫ltima compra de cada producto+gramos
    const ultimasCompras = {};
    compras.forEach(compra => {
        const clave = `${compra.producto_nombre}||${compra.gramos}`;
        if (
            !ultimasCompras[clave] ||
            new Date(compra.fecha) > new Date(ultimasCompras[clave].fecha)
        ) {
            ultimasCompras[clave] = compra;
        }
    });

    // Une con la categor√≠a
    Object.values(ultimasCompras).forEach(compra => {
        const prod = productos.find(p => 
            p.nombre === compra.producto_nombre && 
            String(p.gramos || '') === String(compra.gramos || '')
        );
        compra.categoria_nombre = prod ? prod.categoria_nombre : 'Sin categor√≠a';
    });

    // Agrupa por categor√≠a
    const comprasPorCategoria = {};
    Object.values(ultimasCompras).forEach(compra => {
        const cat = compra.categoria_nombre || 'Sin categor√≠a';
        if (!comprasPorCategoria[cat]) comprasPorCategoria[cat] = [];
        comprasPorCategoria[cat].push(compra);
    });

    doc.setFontSize(9);
    doc.text('Informe de Compras (√∫ltima por producto, ordenado por categor√≠a)', 10, 10);

    let y = 18;
    let col1x = 10;
    let col2x = 110;
    for (const categoria of Object.keys(comprasPorCategoria).sort()) {
        doc.setFont(undefined, 'bold');
        doc.text(`${categoria}:`, 10, y);
        doc.setFont(undefined, 'normal');
        y += 6;
        let col = 0;
        comprasPorCategoria[categoria].forEach(compra => {
            const texto = `${compra.producto_nombre} (${compra.gramos || ''}g) - $${compra.precio_compra}`;
            if (col === 0) {
                doc.text(texto, col1x, y);
                col = 1;
            } else {
                doc.text(texto, col2x, y);
                col = 0;
                y += 6;
            }
            if (y > 280) { doc.addPage(); y = 18; }
        });
        // Si hay una fila sola al final, salta la l√≠nea
        if (col === 1) y += 6;
        y += 2; // Espacio extra entre categor√≠as
    }

    doc.save('informe-compras.pdf');
};

async function eliminarProducto(ean) {
    if (!confirm('¬øSeguro que desea eliminar este producto?')) return;
    try {
        const res = await fetch(`/productos/${ean}`, {
            method: 'DELETE'
        });
        const msg = await res.text();
        alert(msg);
        if (res.ok) {
            await cargarProductos();
            filtrarProductos();
        }
    } catch (err) {
        alert('Error al eliminar producto');
    }
}

document.getElementById('ingresar').addEventListener('keydown', function (e) {
    const esEnter = e.key === 'Enter';
    const esInput = e.target.tagName === 'INPUT';
    const esBotonSubmit = e.target.type === 'submit';

    // Si se presion√≥ Enter en un input (no en el bot√≥n), cancelar el env√≠o
    if (esEnter && esInput && !esBotonSubmit) {
        e.preventDefault();
    }
});

async function cargarMarcasBajoStock() {
    try {
        const res = await fetch('/marcas');
        let marcas = await res.json();
        // Ordenar alfab√©ticamente por nombre
        marcas.sort((a, b) => a.nombre.localeCompare(b.nombre));
        const select = document.getElementById('filtroMarcaBajoStock');
        select.innerHTML = '<option value="">-- Todas las marcas --</option>';
        marcas.forEach(marca => {
            const option = document.createElement('option');
            option.value = marca.nombre;
            option.textContent = marca.nombre;
            select.appendChild(option);
        });
    } catch (e) {
        console.error('Error al cargar marcas para bajo stock:', e);
    }
}

async function mostrarProductosBajoStock() {
    const div = document.getElementById('alerta-bajo-stock');
    div.innerHTML = '';
    try {
        const res = await fetch('/productos-bajo-stock');
        let productos = await res.json();

        // Filtra por marca seleccionada
        const marcaSeleccionada = document.getElementById('filtroMarcaBajoStock').value;
        if (marcaSeleccionada) {
            productos = productos.filter(p => p.marca_nombre === marcaSeleccionada);
        }

        if (productos.length === 0) {
            div.style.display = 'none';
            return;
        }
        div.style.display = 'block';

        // Agrupa por categor√≠a y por stock
        const categorias = {};
        productos.forEach(p => {
            const cat = p.categoria_nombre || 'Sin categor√≠a';
            if (!categorias[cat]) categorias[cat] = { '2': [], '1': [], '0': [] };
            if (p.stock === 2) categorias[cat]['2'].push(p);
            else if (p.stock === 1) categorias[cat]['1'].push(p);
            else categorias[cat]['0'].push(p);
        });

        let expandido = true;

        function render() {
            div.innerHTML = `
                <div style="background:#ffd6d6; color:#b71c1c; border:1px solid #b71c1c; padding:10px; margin-bottom:10px; border-radius:6px;">
                    <b>¬°Atenci√≥n!</b> Productos por acabarse, agrupados por categor√≠a y nivel de stock:
                    <button id="toggle-bajo-stock" style="margin-left:10px; font-size:12px;">
                        ${expandido ? 'Ocultar' : 'Mostrar'}
                    </button>
                    <div id="bajo-stock-lista" style="margin-top:8px;${expandido ? '' : 'display:none;'}">
                        ${Object.keys(categorias).sort().map(cat => `
                            <div style="margin-bottom:10px;">
                                <span style="font-weight:bold; color:#388e3c;">${cat}</span>
                                ${['2','1','0'].map(nivel => categorias[cat][nivel].length > 0 ? `
                                    <div style="margin-left:15px;">
                                        <span style="color:${nivel==='0'?'#d32f2f':nivel==='1'?'#f57c00':'#fbc02d'}; font-weight:bold;">
                                            Stock = ${nivel}:
                                        </span>
                                        <ul style="margin:4px 0 0 20px;">
                                            ${categorias[cat][nivel].map(p => `
                                                <li>
                                                    <b>${p.nombre}</b> (${p.gramos || ''}g)
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : '').join('')}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('toggle-bajo-stock').onclick = function() {
                expandido = !expandido;
                render();
            };
        }

        render();
    } catch (e) {
        div.innerHTML = '';
        div.style.display = 'none';
    }
}

document.getElementById('filtroMarcaBajoStock').addEventListener('change', mostrarProductosBajoStock);

document.getElementById('btn-exportar-bajo-stock').addEventListener('click', async () => {
    try {
        const res = await fetch('/productos-bajo-stock');
        const productos = await res.json();
        if (!productos.length) {
            alert('No hay productos con bajo stock.');
            return;
        }

        // Agrupar por categor√≠a
        const categorias = {};
        productos.forEach(p => {
            const cat = p.categoria_nombre || 'Sin categor√≠a';
            if (!categorias[cat]) categorias[cat] = [];
            categorias[cat].push(p);
        });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        const pageWidth = pdf.internal.pageSize.getWidth();
        const margin = 10;
        const colWidth = (pageWidth - margin * 3) / 2; // dos columnas
        const lineHeight = 6;
        let x = margin;
        let y = margin + 10;

        pdf.setFontSize(14);
        pdf.text('Listado de Productos con Bajo Stock', pageWidth / 2, margin + 5, { align: 'center' });
        pdf.setFontSize(10);

        for (const categoria of Object.keys(categorias).sort()) {
            pdf.setFont(undefined, 'bold');
            pdf.text(categoria, x, y);
            pdf.setFont(undefined, 'normal');
            y += lineHeight;

            for (const p of categorias[categoria]) {
                const texto = `${p.nombre} (${p.marca_nombre || 'Sin marca'}) - Stock: ${p.stock}`;
                const splitted = pdf.splitTextToSize(texto, colWidth - 2);
                splitted.forEach(line => {
                    pdf.text(line, x, y);
                    y += lineHeight;
                });

                // Salto de columna o p√°gina
                if (y > 280) {
                    if (x === margin) {
                        // pasamos a la segunda columna
                        x = margin + colWidth + margin;
                        y = margin + 15;
                    } else {
                        // nueva p√°gina
                        pdf.addPage();
                        x = margin;
                        y = margin + 15;
                    }
                }
            }
            y += lineHeight; // espacio entre categor√≠as
        }

        pdf.save('productos_bajo_stock.pdf');
    } catch (e) {
        console.error('Error al exportar bajo stock:', e);
        alert('Error al generar el PDF.');
    }
});


    cargarMarcasBajoStock();
    cargarCategorias();
    cargarCategoriasSelect();
    cargarProveedoresFiltro();
    cargarMarcasFiltro();
    cargarProductos();
    mostrarProductosBajoStock();
    </script>
</body>
</html>