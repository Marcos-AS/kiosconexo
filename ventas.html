<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registrar Venta</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Registrar Venta</h1>
    <form id="form-venta">
        <label>Buscar por EAN:</label>
        <input type="text" id="buscarEanVenta" placeholder="Ingrese EAN o nombre" autofocus>
        <br>
        <label>Producto:</label>
        <select id="productoSelect"></select>
        <label>Cantidad:</label>
        <input type="number" id="cantidad" min="1" value="1">
        <br>
        <label class="hidden">Fecha y hora de la venta:</label>
        <input type="datetime-local" id="fechaVenta" class="hidden">
        <br>
        <button type="button" id="agregarProducto">Agregar</button>
    </form>
    <h2>Detalle de la venta</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio unitario</th>
                <th>Subtotal</th>
                <th>Quitar</th>
            </tr>
        </thead>
        <tbody id="detalleVenta"></tbody>
    </table>
    <h3>Total: $<span id="totalVenta">0</span></h3>


    <label for="medioPago">Medio de pago:</label>
    <select id="medioPago">
        <option value="efectivo">Efectivo</option>
        <option value="transf">Transferencia</option>
        <option value="qr">QR</option>
        <option value="debito">D√©bito</option>
    </select>
    <button id="registrarVenta">Registrar Venta</button>

    <h2>Ventas realizadas</h2>
    <label for="filtroFecha">Filtrar por fecha:</label>
    <input type="date" id="filtroFecha">
    <button id="btnFiltrarFecha">Filtrar</button>
    <button id="btnLimpiarFecha">Limpiar</button>
    <!-- NUEVO BOT√ìN -->
    <button id="btnExpandirTodas">Expandir/Colapsar todas</button>
    <table border="1">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Total</th>
                <th>Medio de pago</th> <!-- üëà Nueva columna -->
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Venta</th>
                <th>Precio Compra</th>
                <th>Ganancia</th>
                <th>% Ganancia</th> 
            </tr>
        </thead>
        <tbody id="ventasRealizadas"></tbody>
    </table>

    <h3>Total de ventas en el per√≠odo: $<span id="totalVentasPeriodo">0</span></h3>
    <h3>Total de diferencia (ganancia): $<span id="totalDiferenciaPeriodo">0</span></h3>
    <h3>Total en caja: $<span id="totalCaja">0</span></h3>
    <label for="efectivoApertura">Efectivo inicial hoy:</label>
<input type="number" id="efectivoApertura" min="0" value="0">
<button id="btnAbrirCaja">Abrir caja</button>

<!-- NUEVO: Retiro de caja -->
<label for="retiroCaja">Retiro de caja:</label>
<input type="number" id="retiroCaja" min="1" value="0">
<button id="btnRetirarCaja">Retirar</button>
<!-- ...existing code... -->

    <script>
        let productos = [];
        let detalle = [];
        let promociones = [];
        let promocionesCombinadas = [];

    async function cargarPromocionesCombinadas() {
        const res = await fetch('/promociones-combinadas');
        promocionesCombinadas = await res.json();
    }

        async function cargarPromociones() {
            const res = await fetch('/promociones');
            promociones = await res.json();
            await cargarPromocionesCombinadas();
        }

function renderSelectProductos(filtro = '') {
    const select = document.getElementById('productoSelect');
    select.innerHTML = '';
    productos
        .filter(p =>
            (p.stock ?? 0) > 0 && // ‚úÖ Mostrar solo stock mayor a 0
            (
                p.ean.includes(filtro) ||
                p.nombre.toLowerCase().includes(filtro.toLowerCase())
            )
        )
        .forEach(p => {
            const option = document.createElement('option');
            option.value = p.ean;
            option.textContent = `${p.nombre} (EAN: ${p.ean}, Stock: ${p.stock ?? 0}, Gramos: ${p.gramos ?? ''})`;
            select.appendChild(option);
        });
}


        document.getElementById('buscarEanVenta').addEventListener('input', function() {
            renderSelectProductos(this.value.trim());
        });

        document.getElementById('buscarEanVenta').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const eanIngresado = this.value.trim();
        if (!eanIngresado) return;
        const prod = productos.find(p => p.ean === eanIngresado);
        if (prod) {
            // Si ya est√° en el detalle, suma cantidad
            const existente = detalle.find(d => d.ean === prod.ean);
            if (existente) {
                existente.cantidad += 1;
            } else {
                detalle.push({ ean: prod.ean, cantidad: 1 });
            }
            renderDetalle();
        } else {
            alert('Producto no encontrado o sin stock');
        }
        this.value = '';
        this.focus();
    }
});

function aplicarPromocionesCombinadas(detalle) {
    // Copia profunda del detalle
    let productosRestantes = detalle.map(p => ({ ...p }));
    let itemsPromo = [];
    let totalPromo = 0;

    // Agrupa promociones combinadas por id
    function agruparPromos(promosCombinadas) {
        const promos = {};
        for (const promo of promocionesCombinadas) {
            if (!promos[promo.id]) promos[promo.id] = { precio_total: promo.precio_total, productos: [] };
            promo.productos.forEach(prod => {
                promos[promo.id].productos.push({ ean: prod.producto_ean, cantidad: prod.cantidad });
            });
        }
        return promos;
    }

    function encontrarPromocionAplicable(productosCarrito, promosCombinadas) {
        const promos = agruparPromos(promosCombinadas);
        for (const promoId in promos) {
            const promo = promos[promoId];
            let aplica = true;
            let veces = Infinity;
            for (const prod of promo.productos) {
                const enCarrito = productosCarrito.find(p => p.ean === prod.ean);
                if (!enCarrito || enCarrito.cantidad < prod.cantidad) {
                    aplica = false;
                    break;
                }
                veces = Math.min(veces, Math.floor(enCarrito.cantidad / prod.cantidad));
            }
            if (aplica && veces > 0) {
                return { promo, veces };
            }
        }
        return null;
    }

    while (true) {
        const promoAplicable = encontrarPromocionAplicable(productosRestantes, promocionesCombinadas);
        if (!promoAplicable) break;
        const { promo, veces } = promoAplicable;
        totalPromo += promo.precio_total * veces;

        // Calcula precio unitario para cada producto de la promo combinada
        const totalUnidades = promo.productos.reduce((acc, prod) => acc + prod.cantidad, 0);
        const precioUnitarioPromo = promo.precio_total / totalUnidades;

        for (const prod of promo.productos) {
            itemsPromo.push({
                ean: prod.ean,
                cantidad: prod.cantidad * veces,
                precio: precioUnitarioPromo,
                subtotal: precioUnitarioPromo * prod.cantidad * veces,
                promoCombinada: true
            });
            // Resta productos usados en la promoci√≥n
            const prodCarrito = productosRestantes.find(p => p.ean === prod.ean);
            prodCarrito.cantidad -= prod.cantidad * veces;
        }
        productosRestantes = productosRestantes.filter(p => p.cantidad > 0);
    }
    return { itemsPromo, productosRestantes, totalPromo };
}

        function renderDetalle() {
    const tbody = document.getElementById('detalleVenta');
    tbody.innerHTML = '';
    let total = 0;

    // Aplica promociones combinadas primero
    const { itemsPromo, productosRestantes, totalPromo } = aplicarPromocionesCombinadas(detalle);

    // Renderiza productos con promo combinada
    itemsPromo.forEach((item, idx) => {
        const prod = productos.find(p => p.ean === item.ean);
        total += item.subtotal;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${prod ? prod.nombre : item.ean}</td>
            <td>${item.cantidad}</td>
            <td>${item.precio.toFixed(2)} <span style="color:blue">(Promo combinada)</span></td>
            <td>${item.subtotal.toFixed(2)}</td>
            <td></td>
        `;
        tbody.appendChild(tr);
    });

    // Renderiza el resto de productos (promos individuales o normales)
    productosRestantes.forEach((item, idx) => {
        const prod = productos.find(p => p.ean === item.ean);
        let precio = prod.precio_venta ?? 0;
        let subtotal = precio * item.cantidad;
        let promoAplicada = false;

        // Buscar promoci√≥n individual v√°lida para el producto
        const promo = promociones
            .filter(p => p.producto_ean === item.ean)
            .sort((a, b) => b.cantidad - a.cantidad)[0];

        if (promo && item.cantidad >= promo.cantidad) {
            const precioUnitarioPromo = promo.precio_promocion / promo.cantidad;
            subtotal = item.cantidad * precioUnitarioPromo;
            precio = precioUnitarioPromo;
            promoAplicada = true;
        }

        total += subtotal;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${prod.nombre}</td>
            <td>
                <input type="number" min="1" value="${item.cantidad}" style="width:60px"
                    onchange="cambiarCantidadDetalle(${idx}, this.value)">
            </td>
            <td>${precio.toFixed(2)}${promoAplicada ? ' <span style="color:green">(Promo)</span>' : ''}</td>
            <td>${subtotal.toFixed(2)}</td>
            <td><button onclick="quitarProducto(${idx})">Quitar</button></td>
        `;
        tbody.appendChild(tr);
    });
    document.getElementById('totalVenta').textContent = total.toFixed(2);
}

        // Nueva funci√≥n global para cambiar cantidad
        window.cambiarCantidadDetalle = function(idx, nuevaCantidad) {
            nuevaCantidad = parseInt(nuevaCantidad);
            if (isNaN(nuevaCantidad) || nuevaCantidad < 1) return;
            detalle[idx].cantidad = nuevaCantidad;
            renderDetalle();
        };

        window.quitarProducto = function(idx) {
            detalle.splice(idx, 1);
            renderDetalle();
        }

        document.getElementById('agregarProducto').onclick = function() {
            const ean = document.getElementById('productoSelect').value;
            const cantidad = parseInt(document.getElementById('cantidad').value);
            if (!ean || cantidad < 1) return;
            const existente = detalle.find(d => d.ean === ean);
            if (existente) {
                existente.cantidad += cantidad;
            } else {
                detalle.push({ ean, cantidad });
            }
            renderDetalle();
            document.getElementById('buscarEanVenta').value = '';
            document.getElementById('cantidad').value = 1;
            document.getElementById('buscarEanVenta').focus();
        };

let estadoExpandidoGlobal = false; // Estado global para expandir/colapsar

async function cargarVentasRealizadas() {
    const fecha = document.getElementById('filtroFecha').value;
    let url = '/ventas';
    if (fecha) {
        url += '?fecha=' + encodeURIComponent(fecha);
    }
    const res = await fetch(url);
    const ventas = await res.json();

    const tbody = document.getElementById('ventasRealizadas');
    tbody.innerHTML = '';

    let totalPeriodo = 0;
    let totalDiferencia = 0;

    ventas.forEach((v, ventaIndex) => {
        totalPeriodo += parseFloat(v.total) || 0;

        const trVenta = document.createElement('tr');
        trVenta.style.backgroundColor = '#f0f0f0';
        trVenta.style.cursor = 'pointer';
        trVenta.innerHTML = `
            <td>${new Date(v.fecha).toLocaleString()}</td>
            <td>$${v.total}</td>
            <td>${v.medio_pago || '-'}</td> <!-- üëà Mostrar medio de pago -->
            <td colspan="4"><strong>Ver productos ‚ñº</strong></td>
        `;
        tbody.appendChild(trVenta);

        v.detalle.forEach(d => {
            const pv = parseFloat(d.precio_unitario) || 0;
            const pc = parseFloat(d.precio_compra) || 0;
            const cant = parseFloat(d.cantidad) || 0;
            const diferencia = (pv - pc) * cant;
            const porcentajeGanancia = pc ? ((pv - pc) / pc) * 100 : 0;

            totalDiferencia += diferencia;

            const trDetalle = document.createElement('tr');
            trDetalle.classList.add(`detalle-venta-${ventaIndex}`);
            trDetalle.style.display = estadoExpandidoGlobal ? '' : 'none';
            trDetalle.innerHTML = `
                <td></td>
                <td></td>
                <td>${d.producto_nombre || d.producto}</td>
                <td>${cant}</td>
                <td>${pv.toFixed(2)}</td>
                <td>${pc ? pc.toFixed(2) : '-'}</td>
                <td>${pc ? diferencia.toFixed(2) : '-'}</td>
                <td>${pc ? porcentajeGanancia.toFixed(2) + '%' : '-'}</td>
            `;
            tbody.appendChild(trDetalle);
        });

        trVenta.addEventListener('click', () => {
            const filasDetalle = document.querySelectorAll(`.detalle-venta-${ventaIndex}`);
            const mostrando = filasDetalle[0].style.display === '';
            filasDetalle.forEach(fila => {
                fila.style.display = mostrando ? 'none' : '';
            });
            const flecha = trVenta.querySelector('td[colspan] strong');
            flecha.textContent = mostrando ? 'Ver productos ‚ñº' : 'Ocultar productos ‚ñ≤';
        });
    });

    document.getElementById('totalVentasPeriodo').textContent = totalPeriodo.toFixed(2);
    document.getElementById('totalDiferenciaPeriodo').textContent = totalDiferencia.toFixed(2);
}

// NUEVO: Bot√≥n para expandir/colapsar todas las filas
document.getElementById('btnExpandirTodas').onclick = function() {
    estadoExpandidoGlobal = !estadoExpandidoGlobal;
    const filas = document.querySelectorAll('[class^="detalle-venta-"]');
    filas.forEach(fila => {
        fila.style.display = estadoExpandidoGlobal ? '' : 'none';
    });
    // Cambia el texto de todos los botones de cada venta
    document.querySelectorAll('td[colspan] strong').forEach(flecha => {
        flecha.textContent = estadoExpandidoGlobal ? 'Ocultar productos ‚ñ≤' : 'Ver productos ‚ñº';
    });
};

async function mostrarTotalCaja() {
    const res = await fetch('/caja');
    const data = await res.json();
    const totalCaja = Number(data.caja) || 0;
    document.getElementById('totalCaja').textContent = totalCaja.toFixed(2);
}

// Llama a mostrarTotalCaja al cargar y despu√©s de registrar efectivo o venta
mostrarTotalCaja();

document.getElementById('btnAbrirCaja').onclick = async function() {
    const efectivo = parseFloat(document.getElementById('efectivoApertura').value) || 0;
    const res = await fetch('/abrir-caja', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ efectivo })
    });
    const msg = await res.text();
    alert(msg);
    mostrarTotalCaja();
};

document.getElementById('btnRetirarCaja').onclick = async function() {
    const retiro = parseFloat(document.getElementById('retiroCaja').value) || 0;
    if (retiro <= 0) {
        alert('Ingrese un monto v√°lido para retirar');
        return;
    }
    const res = await fetch('/retiro-caja', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ retiro })
    });
    const msg = await res.text();
    alert(msg);
    document.getElementById('retiroCaja').value = 0;
    mostrarTotalCaja();
};

async function verificarCajaAbiertaHoy() {
    const hoy = new Date().toISOString().split('T')[0];
    const res = await fetch('/caja-abierta?fecha=' + hoy);
    const data = await res.json();
    if (data.abierta) {
        document.getElementById('efectivoApertura').disabled = true;
        document.getElementById('btnAbrirCaja').disabled = true;
    } else {
        document.getElementById('efectivoApertura').disabled = false;
        document.getElementById('btnAbrirCaja').disabled = false;
    }
}

async function cargarProductos() {
    const res = await fetch('/productos');
    productos = await res.json();
    renderSelectProductos();
}

function getFechaLocal() {
    const ahora = new Date();
    const year = ahora.getFullYear();
    const month = String(ahora.getMonth() + 1).padStart(2, '0');
    const day = String(ahora.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

document.addEventListener("DOMContentLoaded", () => {
    const hoy = getFechaLocal();
    document.getElementById("filtroFecha").value = hoy;
    cargarVentasRealizadas();
    verificarCajaAbiertaHoy();
    cargarProductos();
    cargarPromociones();
    setFechaActual();
});


// Modifica el registro de venta para enviar el medio de pago
document.getElementById('registrarVenta').onclick = async function() {
    if (detalle.length === 0) {
        alert('Agrega al menos un producto');
        return;
    }
    const ahora = new Date();
    const fechaVenta = ahora.toISOString().slice(0, 19).replace('T', ' ');
    const medioPago = document.getElementById('medioPago').value;

    // Aplica promociones combinadas y separa el detalle
    const { itemsPromo, productosRestantes } = aplicarPromocionesCombinadas(detalle);

    // Arma el detalle final con precio unitario
    const detalleFinal = [
        ...itemsPromo.map(item => ({
            ean: item.ean,
            cantidad: item.cantidad,
            precio_unitario: item.precio
        })),
        ...productosRestantes.map(item => {
            const prod = productos.find(p => p.ean === item.ean);
            let precio = prod.precio_venta ?? 0;
            // Buscar promoci√≥n individual v√°lida para el producto
            const promo = promociones
                .filter(p => p.producto_ean === item.ean)
                .sort((a, b) => b.cantidad - a.cantidad)[0];
            if (promo && item.cantidad >= promo.cantidad) {
                precio = promo.precio_promocion / promo.cantidad;
            }
            return {
                ean: item.ean,
                cantidad: item.cantidad,
                precio_unitario: precio
            };
        })
    ];

    const res = await fetch('/ventas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productos: detalleFinal, fecha: fechaVenta, medio_pago: medioPago })
    });
    const msg = await res.text();
    alert(msg);

    detalle = [];
    renderDetalle();
    cargarVentasRealizadas();
    mostrarTotalCaja();
};


        function setFechaActual() {
            const ahora = new Date();
            const year = ahora.getFullYear();
            const month = String(ahora.getMonth() + 1).padStart(2, '0');
            const day = String(ahora.getDate()).padStart(2, '0');
            const hours = String(ahora.getHours()).padStart(2, '0');
            const minutes = String(ahora.getMinutes()).padStart(2, '0');
            // Formato: yyyy-MM-ddTHH:mm
            const local = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('fechaVenta').value = local;
        }
        setFechaActual();

        document.getElementById('btnFiltrarFecha').onclick = cargarVentasRealizadas;
        document.getElementById('btnLimpiarFecha').onclick = function() {
            document.getElementById('filtroFecha').value = '';
            cargarVentasRealizadas();
        };

        document.addEventListener("DOMContentLoaded", () => {
          const hoy = new Date().toISOString().split("T")[0];
          document.getElementById("filtroFecha").value = hoy;
          cargarVentasRealizadas(); // ya carga filtrado a hoy
        });

    </script>
</body>
</html>