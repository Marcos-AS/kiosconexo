<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registrar Venta</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Registrar Venta</h1>
    <form id="form-venta">
        <label>Buscar por EAN:</label>
        <input type="text" id="buscarEanVenta" placeholder="Ingrese EAN o nombre">
        <br>
        <label>Producto:</label>
        <select id="productoSelect"></select>
        <label>Cantidad:</label>
        <input type="number" id="cantidad" min="1" value="1">
        <br>
        <label class="hidden">Fecha y hora de la venta:</label>
        <input type="datetime-local" id="fechaVenta" class="hidden">
        <br>
        <button type="button" id="agregarProducto">Agregar</button>
    </form>
    <h2>Detalle de la venta</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio unitario</th>
                <th>Subtotal</th>
                <th>Quitar</th>
            </tr>
        </thead>
        <tbody id="detalleVenta"></tbody>
    </table>
    <h3>Total: $<span id="totalVenta">0</span></h3>
    <button id="registrarVenta">Registrar Venta</button>

    <h2>Ventas realizadas</h2>
    <label for="filtroFecha">Filtrar por fecha:</label>
    <input type="date" id="filtroFecha">
    <button id="btnFiltrarFecha">Filtrar</button>
    <button id="btnLimpiarFecha">Limpiar</button>
    <table border="1">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Total</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Venta</th>
                <th>Precio Compra</th>
                <th>Ganancia</th>
                <th>% Ganancia</th> 
            </tr>
        </thead>
        <tbody id="ventasRealizadas"></tbody>
    </table>

    <h3>Total de ventas en el perÃ­odo: $<span id="totalVentasPeriodo">0</span></h3>
    <h3>Total de diferencia (ganancia): $<span id="totalDiferenciaPeriodo">0</span></h3>


    <script>
        let productos = [];
        let detalle = [];

        async function cargarProductos() {
            const res = await fetch('/productos');
            productos = await res.json();
            renderSelectProductos();
        }

function renderSelectProductos(filtro = '') {
    const select = document.getElementById('productoSelect');
    select.innerHTML = '';
    productos
        .filter(p =>
            (p.stock ?? 0) > 0 && // âœ… Mostrar solo stock mayor a 0
            (
                p.ean.includes(filtro) ||
                p.nombre.toLowerCase().includes(filtro.toLowerCase())
            )
        )
        .forEach(p => {
            const option = document.createElement('option');
            option.value = p.ean;
            option.textContent = `${p.nombre} (EAN: ${p.ean}, Stock: ${p.stock ?? 0}, Gramos: ${p.gramos ?? ''})`;
            select.appendChild(option);
        });
}


        document.getElementById('buscarEanVenta').addEventListener('input', function() {
            renderSelectProductos(this.value.trim());
        });

        function renderDetalle() {
            const tbody = document.getElementById('detalleVenta');
            tbody.innerHTML = '';
            let total = 0;
            detalle.forEach((item, idx) => {
                const prod = productos.find(p => p.ean === item.ean);
                const precio = prod.precio_venta ?? 0;
                const subtotal = precio * item.cantidad;
                total += subtotal;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${prod.nombre}</td>
                    <td>${item.cantidad}</td>
                    <td>${precio}</td>
                    <td>${subtotal.toFixed(2)}</td>
                    <td><button onclick="quitarProducto(${idx})">Quitar</button></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('totalVenta').textContent = total.toFixed(2);
        }

        window.quitarProducto = function(idx) {
            detalle.splice(idx, 1);
            renderDetalle();
        }

        document.getElementById('agregarProducto').onclick = function() {
            const ean = document.getElementById('productoSelect').value;
            const cantidad = parseInt(document.getElementById('cantidad').value);
            if (!ean || cantidad < 1) return;
            const existente = detalle.find(d => d.ean === ean);
            if (existente) {
                existente.cantidad += cantidad;
            } else {
                detalle.push({ ean, cantidad });
            }
            renderDetalle();
            document.getElementById('buscarEanVenta').value = '';
            document.getElementById('cantidad').value = 1;
            document.getElementById('buscarEanVenta').focus();
        };

async function cargarVentasRealizadas() {
    const fecha = document.getElementById('filtroFecha').value;
    let url = '/ventas';
    if (fecha) {
        url += '?fecha=' + encodeURIComponent(fecha);
    }
    const res = await fetch(url);
    const ventas = await res.json();

    const tbody = document.getElementById('ventasRealizadas');
    tbody.innerHTML = '';

    let totalPeriodo = 0;
    let totalDiferencia = 0; // ðŸ”¹ acumulador de ganancia

    ventas.forEach((v, ventaIndex) => {
        totalPeriodo += parseFloat(v.total) || 0;

        const trVenta = document.createElement('tr');
        trVenta.style.backgroundColor = '#f0f0f0';
        trVenta.style.cursor = 'pointer';
        trVenta.innerHTML = `
            <td>${new Date(v.fecha).toLocaleString()}</td>
            <td>$${v.total}</td>
            <td colspan="4"><strong>Ver productos â–¼</strong></td>
        `;
        tbody.appendChild(trVenta);

v.detalle.forEach(d => {
    const pv = parseFloat(d.precio_unitario) || 0;
    const pc = parseFloat(d.precio_compra) || 0;
    const cant = parseFloat(d.cantidad) || 0;
    const diferencia = (pv - pc) * cant;
    const porcentajeGanancia = pc ? ((pv - pc) / pc) * 100 : 0;


    // ðŸ”¹ Acumular diferencia global
    totalDiferencia += diferencia;

    const trDetalle = document.createElement('tr');
    trDetalle.classList.add(`detalle-venta-${ventaIndex}`);
    trDetalle.style.display = 'none';
    trDetalle.innerHTML = `
        <td></td>
        <td></td>
        <td>${d.producto_nombre || d.producto}</td>
        <td>${cant}</td>
        <td>${pv.toFixed(2)}</td>
        <td>${pc ? pc.toFixed(2) : '-'}</td>
        <td>${pc ? diferencia.toFixed(2) : '-'}</td> <!-- ðŸ”¹ diferencia por fila -->
        <td>${pc ? porcentajeGanancia.toFixed(2) + '%' : '-'}</td>
        `;
    tbody.appendChild(trDetalle);
});


        trVenta.addEventListener('click', () => {
            const filasDetalle = document.querySelectorAll(`.detalle-venta-${ventaIndex}`);
            const mostrando = filasDetalle[0].style.display === '';
            filasDetalle.forEach(fila => {
                fila.style.display = mostrando ? 'none' : '';
            });
            const flecha = trVenta.querySelector('td[colspan] strong');
            flecha.textContent = mostrando ? 'Ver productos â–¼' : 'Ocultar productos â–²';
        });
    });

    // ðŸ”¹ Mostrar totales
    document.getElementById('totalVentasPeriodo').textContent = totalPeriodo.toFixed(2);
    document.getElementById('totalDiferenciaPeriodo').textContent = totalDiferencia.toFixed(2);
}




document.getElementById('registrarVenta').onclick = async function() {
    if (detalle.length === 0) {
        alert('Agrega al menos un producto');
        return;
    }

    // ðŸ”¹ Tomar la fecha/hora actual en formato compatible con datetime-local
    const ahora = new Date();
    const fechaVenta = ahora.toISOString().slice(0, 19).replace('T', ' ');

    const res = await fetch('/ventas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productos: detalle, fecha: fechaVenta })
    });
    const msg = await res.text();
    alert(msg);

    // Resetear
    detalle = [];
    renderDetalle();
    cargarVentasRealizadas();
};

    cargarProductos();

        function setFechaActual() {
            const ahora = new Date();
            const year = ahora.getFullYear();
            const month = String(ahora.getMonth() + 1).padStart(2, '0');
            const day = String(ahora.getDate()).padStart(2, '0');
            const hours = String(ahora.getHours()).padStart(2, '0');
            const minutes = String(ahora.getMinutes()).padStart(2, '0');
            // Formato: yyyy-MM-ddTHH:mm
            const local = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('fechaVenta').value = local;
        }
        setFechaActual();

        document.getElementById('btnFiltrarFecha').onclick = cargarVentasRealizadas;
        document.getElementById('btnLimpiarFecha').onclick = function() {
            document.getElementById('filtroFecha').value = '';
            cargarVentasRealizadas();
        };

        document.addEventListener("DOMContentLoaded", () => {
          const hoy = new Date().toISOString().split("T")[0];
          document.getElementById("filtroFecha").value = hoy;
          cargarVentasRealizadas(); // ya carga filtrado a hoy
        });

    </script>
</body>
</html>