<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Promociones Combinadas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background: #f5f5f5; }
        .promo-nombre { font-size: 1.2em; font-weight: bold; color: #2a5d9f; }
    </style>
</head>
<body>
    <h1>Promociones Combinadas Registradas</h1>
    <div id="contenedor-promos"></div>
    <script>
        async function cargarPromos() {
            // Trae todas las promociones combinadas
            const resPromos = await fetch('/promociones-combinadas');
            const promos = await resPromos.json();

            // Trae todos los productos para obtener el precio de venta normal
            const resProductos = await fetch('/productos');
            const productos = await resProductos.json();
            const mapaProductos = {};
            productos.forEach(p => mapaProductos[p.ean] = p);

            const contenedor = document.getElementById('contenedor-promos');
            contenedor.innerHTML = '';

            promos.forEach(promo => {
                let totalNormal = 0;
                let tabla = `
                    <div class="promo-nombre">${promo.nombre}</div>
                    <button onclick="eliminarPromo(${promo.id})" style="color:#b71c1c; margin-bottom:8px;">Eliminar</button>
                    <br>
                    <label>
                        Total promo: $
                        <input type="number" id="totalPromo-${promo.id}" value="${Number(promo.precio_total) || 0}" min="0" step="0.01" style="width:90px;">
                        <button onclick="editarTotalPromo(${promo.id})">Guardar</button>
                    </label>
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>EAN</th>
                                <th>Cantidad</th>
                                <th>Precio venta normal</th>
                                <th>Subtotal normal</th>
                                <th>Precio unitario promo</th>
                                <th>Subtotal promo</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                const unidadesTotales = promo.productos.reduce((acc, prod) => acc + prod.cantidad, 0);
                const precioUnitarioPromo = (Number(promo.precio_total) / unidadesTotales);

                promo.productos.forEach(prod => {
                    const prodInfo = mapaProductos[prod.producto_ean];
                    const precioNormal = prodInfo ? (prodInfo.precio_venta || 0) : 0;
                    const subtotalNormal = precioNormal * prod.cantidad;
                    totalNormal += subtotalNormal;
                    const subtotalPromo = precioUnitarioPromo * prod.cantidad;
                    tabla += `
                        <tr>
                            <td>${prodInfo ? prodInfo.nombre : prod.producto_ean}</td>
                            <td>${prod.producto_ean}</td>
                            <td>${prod.cantidad}</td>
                            <td>$${precioNormal.toFixed(2)}</td>
                            <td>$${subtotalNormal.toFixed(2)}</td>
                            <td>$${precioUnitarioPromo.toFixed(2)}</td>
                            <td>$${subtotalPromo.toFixed(2)}</td>
                        </tr>
                    `;
                });

                tabla += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="4" style="text-align:right;">Total normal:</th>
                                <th>$${totalNormal.toFixed(2)}</th>
                                <th style="text-align:right;">Total promo:</th>
                                <th>$${(Number(promo.precio_total) || 0).toFixed(2)}</th>
                            </tr>
                        </tfoot>
                    </table>
                `;
                contenedor.innerHTML += `<div id="promo-${promo.id}">${tabla}</div>`;
            });
        }

        async function editarTotalPromo(id) {
            const input = document.getElementById(`totalPromo-${id}`);
            const nuevoTotal = parseFloat(input.value);
            if (isNaN(nuevoTotal) || nuevoTotal < 0) {
                alert('Ingrese un valor válido');
                return;
            }
            await fetch(`/promociones-combinadas/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ precio_total: nuevoTotal })
            });
            await cargarPromos();
        }

        async function eliminarPromo(id) {
            if (!confirm('¿Eliminar esta promoción combinada?')) return;
            await fetch(`/promociones-combinadas/${id}`, { method: 'DELETE' });
            document.getElementById(`promo-${id}`).remove();
        }

        cargarPromos();
    </script>
</body>
</html>