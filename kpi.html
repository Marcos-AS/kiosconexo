<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>KPI de Ventas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f9f9f9;
    }

    h1 {
      text-align: center;
      margin-bottom: 40px;
    }

    section {
      margin-bottom: 50px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    h2 {
      background-color: #007bff;
      color: white;
      padding: 10px;
      margin: 0;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
    }

    .table-container {
      display: none; /* inicialmente colapsada */
      padding: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
    }

    canvas {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>游늵 KPI - Totales de Ventas</h1>

  <section id="por-dia">
    <h2>Totales por D칤a</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Fecha</th><th>Total</th><th>Ticket Promedio</th></tr>
        </thead>
        <tbody id="tabla-dia"></tbody>
      </table>
      <canvas id="grafico-dia" height="150"></canvas>
    </div>
  </section>

  <section id="por-semana">
    <h2>Totales por Semana</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Semana</th><th>Total</th><th>Ticket Promedio</th></tr>
        </thead>
        <tbody id="tabla-semana"></tbody>
      </table>
      <canvas id="grafico-semana" height="150"></canvas>
    </div>
  </section>

  <section id="por-mes">
    <h2>Totales por Mes</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Mes</th><th>Total</th><th>Ticket Promedio</th></tr>
        </thead>
        <tbody id="tabla-mes"></tbody>
      </table>
      <canvas id="grafico-mes" height="150"></canvas>
    </div>
  </section>

  <section id="por-categoria">
  <h2>Totales por Categor칤a</h2>
  <div class="table-container">
    <table>
      <thead>
        <tr><th>Categor칤a</th><th>Total</th><th>Ticket Promedio</th></tr>
      </thead>
      <tbody id="tabla-categoria"></tbody>
    </table>
    <canvas id="grafico-categoria" height="150"></canvas>
  </div>
</section>

<section id="cantidad-por-dia">
  <h2>Cantidad de Ventas por D칤a</h2>
  <div class="table-container">
    <table>
      <thead>
        <tr><th>Fecha</th><th>Cantidad de Ventas</th></tr>
      </thead>
      <tbody id="tabla-cantidad-dia"></tbody>
    </table>
    <canvas id="grafico-cantidad-dia" height="150"></canvas>
  </div>
</section>

<section id="comparativa-mes">
  <h2>Comparativa D칤a a D칤a por Mes</h2>
  <div class="table-container">
    <canvas id="grafico-comparativa-mes" height="200"></canvas>
  </div>
</section>

<section id="comparativa-cantidad-mes">
  <h2>Comparativa Cantidad de Ventas por Mes</h2>
  <div class="table-container">
    <canvas id="grafico-cantidad-mes" height="200"></canvas>
  </div>
</section>

<section id="comparativa-dia-semana">
  <h2>Comparativa Ventas por D칤a de la Semana</h2>
  <div class="table-container">
    <canvas id="grafico-dia-semana" height="200"></canvas>
  </div>
</section>

  <script>
    const API_BASE = 'http://localhost:3000';

    // Funci칩n para colapsar/expandir secciones
    document.querySelectorAll('section h2').forEach(h2 => {
      h2.addEventListener('click', () => {
        const container = h2.nextElementSibling;
        container.style.display = container.style.display === 'block' ? 'none' : 'block';
      });
    });

    async function cargarTotales(tipo) {
      const endpoints = {
        dia: `${API_BASE}/ventas-por-dia`,
        semana: `${API_BASE}/ventas-por-semana`,
        mes: `${API_BASE}/ventas-por-mes`
      };

      const tbody = document.getElementById(`tabla-${tipo}`);
      tbody.innerHTML = '<tr><td colspan="2">Cargando...</td></tr>';

      try {
        const res = await fetch(endpoints[tipo]);
        if (!res.ok) throw new Error('Error al obtener datos');
        const datos = await res.json();

        tbody.innerHTML = '';
        if (datos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="2">Sin datos</td></tr>';
          return;
        }

        const labels = [];
        const totals = [];

        datos.forEach(fila => {
            let periodo, total, cantidad, ticketPromedio;

            if (tipo === 'dia') {
                periodo = fila.fecha.split('T')[0];
                total = fila.total_dia;
                cantidad = fila.cantidad_ventas;
            } else if (tipo === 'semana') {
                periodo = `${fila.inicio_semana.split('T')[0]} a ${fila.fin_semana.split('T')[0]}`;
                total = fila.total_semana;
                cantidad = fila.cantidad_ventas;
            } else if (tipo === 'mes') {
                periodo = fila.mes_nombre || `${fila.anio}-${fila.mes_numero}`;
                total = fila.total_mes;
                cantidad = fila.cantidad_ventas;
            }

            ticketPromedio = cantidad > 0 ? (total / cantidad) : 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${periodo}</td>
            <td>$${Number(total || 0).toFixed(2)}</td>
            <td>$${ticketPromedio.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);

            labels.push(periodo);
            totals.push(total);
        });


            // Invertimos arrays para que los datos m치s recientes queden a la derecha
            labels.reverse();
            totals.reverse();

            // Crear gr치fico
            const ctx = document.getElementById(`grafico-${tipo}`).getContext('2d');
            new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                label: 'Total Ventas',
                data: totals,
                backgroundColor: 'rgba(0, 123, 255, 0.6)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
      });
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="2">Error al cargar datos</td></tr>`;
            console.error(error);
        }
    }

async function cargarCategorias() {
  const tbody = document.getElementById('tabla-categoria');
  tbody.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';

  try {
    const res = await fetch(`${API_BASE}/ganancia-por-categoria`);
    if (!res.ok) throw new Error('Error al obtener categor칤as');
    const datos = await res.json();

    tbody.innerHTML = '';
    if (datos.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3">Sin datos</td></tr>';
      return;
    }

    // 游댳 Ordenar de mayor a menor ganancia
    datos.sort((a, b) => (b.ganancia_total || 0) - (a.ganancia_total || 0));

    const labels = [];
    const totals = [];

    datos.forEach(fila => {
      const ticketPromedio = fila.cantidad_ventas > 0 ? (fila.ganancia_total / fila.cantidad_ventas) : 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fila.categoria}</td>
        <td>$${Number(fila.ganancia_total || 0).toFixed(2)}</td>
        <td>$${ticketPromedio.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);

      labels.push(fila.categoria);
      totals.push(fila.ganancia_total);
    });

    // Crear gr치fico
    const ctx = document.getElementById('grafico-categoria').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { 
        labels, 
        datasets: [{
          label: 'Ganancia por Categor칤a', 
          data: totals, 
          backgroundColor: 'rgba(40, 167, 69, 0.6)', 
          borderColor: 'rgba(40, 167, 69, 1)', 
          borderWidth: 1 
        }] 
      },
      options: { 
        responsive: true, 
        plugins: { legend: { display: false } }, 
        scales: { y: { beginAtZero: true } } 
      }
    });
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="3">Error: ${err.message}</td></tr>`;
    console.error(err);
  }
}

async function cargarCantidadPorDia() {
  const tbody = document.getElementById('tabla-cantidad-dia');
  tbody.innerHTML = '<tr><td colspan="2">Cargando...</td></tr>';

  try {
    const res = await fetch(`${API_BASE}/ventas-por-dia`);
    if (!res.ok) throw new Error('Error al obtener ventas por d칤a');
    const datos = await res.json();

    tbody.innerHTML = '';
    if (datos.length === 0) {
      tbody.innerHTML = '<tr><td colspan="2">Sin datos</td></tr>';
      return;
    }

    const labels = [];
    const cantidades = [];

    datos.forEach(fila => {
      const fecha = fila.fecha.split('T')[0]; // sin hora
      const cantidad = fila.cantidad_ventas;

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${fecha}</td><td>${cantidad}</td>`;
      tbody.appendChild(tr);

      labels.push(fecha);
      cantidades.push(cantidad);
    });

    // Invertir arrays para que los d칤as m치s recientes queden a la derecha
    labels.reverse();
    cantidades.reverse();

    // Crear gr치fico
    const ctx = document.getElementById('grafico-cantidad-dia').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Cantidad de Ventas',
          data: cantidades,
          backgroundColor: 'rgba(255, 193, 7, 0.6)',
          borderColor: 'rgba(255, 193, 7, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="2">Error: ${err.message}</td></tr>`;
    console.error(err);
  }
}

async function cargarComparativaMes() {
  try {
    const res = await fetch(`${API_BASE}/ventas-por-dia`);
    if (!res.ok) throw new Error('Error al obtener ventas por d칤a');
    const datos = await res.json();

    if (datos.length === 0) return;

    // Agrupar por mes
    const meses = {}; // { "2025-09": [ventas por d칤a], "2025-10": [...] }
    datos.forEach(fila => {
      const fecha = fila.fecha.split('T')[0]; // yyyy-mm-dd
      const [anio, mes, dia] = fecha.split('-');
      const key = `${anio}-${mes}`;
      if (!meses[key]) meses[key] = {};
      meses[key][parseInt(dia)] = fila.total_dia || 0;
    });

    // Obtener la lista de d칤as del mes m치s largo
    const dias = Array.from({ length: 31 }, (_, i) => i + 1);

    const datasets = Object.keys(meses).sort().map((mes, idx) => {
      const color = `hsl(${idx * 60}, 70%, 50%)`; // colores distintos
      return {
        label: mes,
        data: dias.map(d => meses[mes][d] || 0),
        borderColor: color,
        backgroundColor: color,
        fill: false,
        tension: 0.2
      };
    });

    const ctx = document.getElementById('grafico-comparativa-mes').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: dias,
        datasets
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { title: { display: true, text: 'D칤a del Mes' } },
          y: { title: { display: true, text: 'Ventas Totales' }, beginAtZero: true }
        }
      }
    });

  } catch (err) {
    console.error('Error en comparativa mes:', err);
  }
}

async function cargarComparativaCantidadMes() {
  try {
    const res = await fetch(`${API_BASE}/ventas-por-dia`);
    if (!res.ok) throw new Error('Error al obtener ventas por d칤a');
    const datos = await res.json();

    if (datos.length === 0) return;

    // Agrupar por mes
    const meses = {}; // { "2025-09": {1: cantidad, 2: cantidad, ...}, ... }
    datos.forEach(fila => {
      const fecha = fila.fecha.split('T')[0];
      const [anio, mes, dia] = fecha.split('-');
      const key = `${anio}-${mes}`;
      if (!meses[key]) meses[key] = {};
      meses[key][parseInt(dia)] = fila.cantidad_ventas || 0;
    });

    const dias = Array.from({ length: 31 }, (_, i) => i + 1);

    const datasets = Object.keys(meses).sort().map((mes, idx) => {
      const color = `hsl(${idx * 60}, 70%, 50%)`;
      return {
        label: mes,
        data: dias.map(d => meses[mes][d] || 0),
        borderColor: color,
        backgroundColor: color,
        fill: false,
        tension: 0.2
      };
    });

    const ctx = document.getElementById('grafico-cantidad-mes').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: dias,
        datasets
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { title: { display: true, text: 'D칤a del Mes' } },
          y: { title: { display: true, text: 'Cantidad de Ventas' }, beginAtZero: true }
        }
      }
    });

  } catch (err) {
    console.error('Error en comparativa cantidad mes:', err);
  }
}

async function cargarComparativaDiaSemana() {
  try {
    const res = await fetch(`${API_BASE}/ventas-por-dia`);
    if (!res.ok) throw new Error('Error al obtener ventas por d칤a');
    const datos = await res.json();

    if (datos.length === 0) return;

    // Agrupar por mes y d칤a de la semana
    const meses = {}; // { "2025-09": {1: cantidad, 2: cantidad, ...7: cantidad} }
    datos.forEach(fila => {
      const fecha = new Date(fila.fecha.split('T')[0]);
      const diaSemana = fecha.getDay(); // 0 = domingo, 1 = lunes, ..., 6 = s치bado
      const mesKey = `${fecha.getFullYear()}-${('0'+(fecha.getMonth()+1)).slice(-2)}`;
      if (!meses[mesKey]) meses[mesKey] = {};
      // sumamos ventas en caso de que haya varias por d칤a
      meses[mesKey][diaSemana] = (meses[mesKey][diaSemana] || 0) + (fila.cantidad_ventas || 0);
    });

    const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi칠', 'Jue', 'Vie', 'S치b'];

    const datasets = Object.keys(meses).sort().map((mes, idx) => {
      const color = `hsl(${idx * 60}, 70%, 50%)`;
      return {
        label: mes,
        data: diasSemana.map((_, i) => meses[mes][i] || 0),
        borderColor: color,
        backgroundColor: color,
        fill: false,
        tension: 0.2
      };
    });

    const ctx = document.getElementById('grafico-dia-semana').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: diasSemana,
        datasets
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Cantidad de Ventas' } },
          x: { title: { display: true, text: 'D칤a de la Semana' } }
        }
      }
    });

  } catch (err) {
    console.error('Error en comparativa d칤a de la semana:', err);
  }
}

// Cargar comparativa d칤a de la semana
cargarComparativaDiaSemana();

// Cargar comparativa cantidad mes
cargarComparativaCantidadMes();

// Cargar la comparativa mes
cargarComparativaMes();

// Cargar la nueva secci칩n
cargarCantidadPorDia();



// Cargar categor칤as
cargarCategorias();


    // Cargar todos los KPIs
    cargarTotales('dia');
    cargarTotales('semana');
    cargarTotales('mes');
  </script>
</body>
</html>
